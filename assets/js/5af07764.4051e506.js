"use strict";(self.webpackChunklogos_docs_template=self.webpackChunklogos_docs_template||[]).push([[865],{2063:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));const r={title:"18/WAKU2-SWAP",name:"Waku SWAP Accounting",status:"deprecated",editor:"Oskar Thor\xe9n &lt;oskarth@titanproxy.com&gt;",contributor:"Ebube Ud &lt;ebube@status.im&gt;"},i=void 0,s={unversionedId:"deprecated/18/swap",id:"deprecated/18/swap",title:"18/WAKU2-SWAP",description:"- Status: deprecated",source:"@site/waku/deprecated/18/swap.md",sourceDirName:"deprecated/18",slug:"/deprecated/18/swap",permalink:"/waku/deprecated/18/swap",draft:!1,tags:[],version:"current",frontMatter:{title:"18/WAKU2-SWAP",name:"Waku SWAP Accounting",status:"deprecated",editor:"Oskar Thor\xe9n &lt;oskarth@titanproxy.com&gt;",contributor:"Ebube Ud &lt;ebube@status.im&gt;"},sidebar:"defaultSidebar",previous:{title:"16/WAKU2-RPC",permalink:"/waku/deprecated/16/rpc"},next:{title:"22/TOY-CHAT",permalink:"/waku/informational/22/toy-chat"}},l={},p=[{value:"Abstract",id:"abstract",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Game Theory - Iterated prisoner&#39;s dilemma / donation game",id:"game-theory---iterated-prisoners-dilemma--donation-game",level:2},{value:"SWAP protocol overview",id:"swap-protocol-overview",level:2},{value:"Accounting",id:"accounting",level:3},{value:"Flow",id:"flow",level:3},{value:"Protobufs",id:"protobufs",level:3},{value:"Incremental integration and roll-out",id:"incremental-integration-and-roll-out",level:2},{value:"Soft phase",id:"soft-phase",level:3},{value:"Mock phase",id:"mock-phase",level:3},{value:"Hard phase",id:"hard-phase",level:3},{value:"Copyright",id:"copyright",level:2},{value:"References",id:"references",level:2}],c={toc:p};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Status: deprecated"),(0,o.kt)("li",{parentName:"ul"},"Editor: Oskar Thor\xe9n ","<",(0,o.kt)("a",{parentName:"li",href:"mailto:oskarth@titanproxy.com"},"oskarth@titanproxy.com"),">")),(0,o.kt)("h2",{id:"abstract"},"Abstract"),(0,o.kt)("p",null,"This specification outlines how we do accounting and settlement based on the provision\nand usage of resources, most immediately bandwidth usage and/or\nstoring and retrieving of Waku message.\nThis enables nodes to cooperate and efficiently share resources,\nand in the case of unequal nodes to settle the difference\nthrough a relaxed payment mechanism in the form of sending cheques."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Protocol identifier*"),": ",(0,o.kt)("inlineCode",{parentName:"p"},"/vac/waku/swap/2.0.0-beta1")),(0,o.kt)("h2",{id:"motivation"},"Motivation"),(0,o.kt)("p",null,"The Waku network makes up a service network, and\nsome nodes provide a useful service to other nodes.\nWe want to account for that, and when imbalances arise, settle this.\nThe core of this approach has some theoretical backing in game theory, and\nvariants of it have practically been proven to work in systems such as Bittorrent.\nThe specific model use was developed by the Swarm project\n(previously part of Ethereum), and\nwe re-use contracts that were written for this purpose."),(0,o.kt)("p",null,"By using a delayed payment mechanism in the form of cheques,\na barter-like mechanism can arise, and\nnodes can decide on their own policy\nas opposed to be strictly tied to a specific payment scheme.\nAdditionally, this delayed settlement eases requirements\non the underlying network in terms of transaction speed or costs."),(0,o.kt)("p",null,"Theoretically, nodes providing and using resources over a long,\nindefinite, period of time can be seen as an iterated form of\n",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Prisoner%27s_dilemma"},"Prisoner's Dilemma (PD)"),".\nSpecifically, and more intuitively,\nsince we have a cost and benefit profile for each provision/usage\n(of Waku Message's, e.g.), and\nthe pricing can be set such that mutual cooperation is incentivized,\nthis can be analyzed as a form of donations game."),(0,o.kt)("h2",{id:"game-theory---iterated-prisoners-dilemma--donation-game"},"Game Theory - Iterated prisoner's dilemma / donation game"),(0,o.kt)("p",null,"What follows is a sketch of what the game looks like between two nodes.\nWe can look at it as a special case of iterated prisoner's dilemma called a\n",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Prisoner%27s_dilemma#Special_case:_donation_game"},"Donation game"),"\nwhere each node can cooperate with some benefit ",(0,o.kt)("inlineCode",{parentName:"p"},"b")," at a personal cost ",(0,o.kt)("inlineCode",{parentName:"p"},"c"),",\nwhere ",(0,o.kt)("inlineCode",{parentName:"p"},"b>c"),"."),(0,o.kt)("p",null,"From A's point of view:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"A/B"),(0,o.kt)("th",{parentName:"tr",align:null},"Cooperate"),(0,o.kt)("th",{parentName:"tr",align:null},"Defect"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Cooperate"),(0,o.kt)("td",{parentName:"tr",align:null},"b-c"),(0,o.kt)("td",{parentName:"tr",align:null},"-c")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Defect"),(0,o.kt)("td",{parentName:"tr",align:null},"b"),(0,o.kt)("td",{parentName:"tr",align:null},"0")))),(0,o.kt)("p",null,"What this means is that if A and B cooperates,\nA gets some benefit ",(0,o.kt)("inlineCode",{parentName:"p"},"b")," minus a cost ",(0,o.kt)("inlineCode",{parentName:"p"},"c"),".\nIf A cooperates and B defects she only gets the cost,\nand if she defects and B cooperates A only gets the benefit.\nIf both defect they get neither benefit nor cost."),(0,o.kt)("p",null,"The generalized form of PD is:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"A/B"),(0,o.kt)("th",{parentName:"tr",align:null},"Cooperate"),(0,o.kt)("th",{parentName:"tr",align:null},"Defect"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Cooperate"),(0,o.kt)("td",{parentName:"tr",align:null},"R"),(0,o.kt)("td",{parentName:"tr",align:null},"S")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Defect"),(0,o.kt)("td",{parentName:"tr",align:null},"T"),(0,o.kt)("td",{parentName:"tr",align:null},"P")))),(0,o.kt)("p",null,"With R=reward, S=Sucker's payoff, T=temptation, P=punishment"),(0,o.kt)("p",null,"And the following holds:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"T>R>P>S")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"2R>T+S"))),(0,o.kt)("p",null,"In our case, this means ",(0,o.kt)("inlineCode",{parentName:"p"},"b>b-c>0>-c")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"2(b-c)> b-c")," which is trivially true."),(0,o.kt)("p",null,'As this is an iterated game with no clear finishing point in most circumstances,\na tit-for-tat strategy is simple, elegant and functional.\nTo be more theoretically precise,\nthis also requires reasonable assumptions on error rate and discount parameter.\nThis captures notions such as\n"does the perceived action reflect the intended action" and\n"how much do you value future (uncertain) actions compared to previous actions".\nSee ',(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/The_Evolution_of_Cooperation"},"Axelrod - Evolution of Cooperation (book)"),"\nfor more details.\nIn specific circumstances,\nnodes can choose slightly different policies if there's a strong need for it.\nA policy is simply how a node chooses to act given a set of circumstances."),(0,o.kt)("p",null,"A tit-for-tat strategy basically means:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"cooperate first (perform service/beneficial action to other node)"),(0,o.kt)("li",{parentName:"ul"},"defect when node stops cooperating (disconnect and similar actions),\ni.e. when it stops performing according to set parameters re settlement"),(0,o.kt)("li",{parentName:"ul"},"resume cooperation if other node does so")),(0,o.kt)("p",null,"This can be complemented with node selection mechanisms."),(0,o.kt)("h2",{id:"swap-protocol-overview"},"SWAP protocol overview"),(0,o.kt)("p",null,"We use SWAP for accounting and\nsettlement in conjunction with other request/reply protocols in Waku v2,\nwhere accounting is done in a pairwise manner.\nIt is an acronym with several possible meanings (as defined in the Book\nof Swarm), for example:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"service wanted and provided"),(0,o.kt)("li",{parentName:"ul"},"settle with automated payments"),(0,o.kt)("li",{parentName:"ul"},"send waiver as payment"),(0,o.kt)("li",{parentName:"ul"},"start without a penny")),(0,o.kt)("p",null,"This approach is based on communicating payment thresholds and\nsending cheques as indications of later payments.\nCommunicating payment thresholds MAY be done out-of-band or as part of the handshake.\nSending cheques is done once payment threshold is hit."),(0,o.kt)("p",null,"See ",(0,o.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20210126130038/https://gateway.ethswarm.org/bzz/latest.bookofswarm.eth"},"Book of Swarm"),"\nsection 3.2. on Peer-to-peer accounting etc., for more context and details."),(0,o.kt)("h3",{id:"accounting"},"Accounting"),(0,o.kt)("p",null,'Nodes perform their own accounting for each relevant peer\nbased on some "volume"/bandwidth metric.\nFor now we take this to mean the number of ',(0,o.kt)("inlineCode",{parentName:"p"},"WakuMessage"),"s exchanged."),(0,o.kt)("p",null,'Additionally, a price is attached to each unit.\nCurrently, this is simply a "karma counter" and equal to 1 per message.'),(0,o.kt)("p",null,"Each accounting balance SHOULD be w.r.t. to a given protocol it is accounting for."),(0,o.kt)("p",null,"NOTE: This may later be complemented with other metrics,\neither as part of SWAP or more likely outside of it.\nFor example, online time can be communicated and\nattested to as a form of enhanced quality of service to inform peer selection."),(0,o.kt)("h3",{id:"flow"},"Flow"),(0,o.kt)("p",null,"Assuming we have two store nodes,\none operating mostly as a client (A) and another as server (B)."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Node A performs a handshake with B node.\nB node responds and both nodes communicate their payment threshold."),(0,o.kt)("li",{parentName:"ol"},"Node A and B creates an accounting entry for the other peer,\nkeep track of peer and current balance."),(0,o.kt)("li",{parentName:"ol"},"Node A issues a ",(0,o.kt)("inlineCode",{parentName:"li"},"HistoryRequest"),", and B responds with a ",(0,o.kt)("inlineCode",{parentName:"li"},"HistoryResponse"),".\nBased on the number of WakuMessages in the response,\nboth nodes update their accounting records."),(0,o.kt)("li",{parentName:"ol"},"When payment threshold is reached,\nNode A sends over a cheque to reach a neutral balance.\nSettlement of this is currently out of scope,\nbut would occur through a SWAP contract (to be specified).\n(mock and hard phase)."),(0,o.kt)("li",{parentName:"ol"},"If disconnect threshold is reached, Node B disconnects Node A (mock and hard phase).")),(0,o.kt)("p",null,"Note that not all of these steps are mandatory in initial stages,\nsee below for more details.\nFor example, the payment threshold MAY initially be set out of bounds,\nand policy is only activated in the mock and hard phase."),(0,o.kt)("h3",{id:"protobufs"},"Protobufs"),(0,o.kt)("p",null,"We use protobuf to specify the handshake and signature.\nThis current protobuf is a work in progress.\nThis is needed for mock and hard phase."),(0,o.kt)("p",null,"A handshake gives initial information about payment thresholds and\npossibly other information.\nA cheque is best thought of as a promise to pay at a later date."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-protobuf"},"\nmessage Handshake {\n    bytes payment_threshold = 1;\n}\n\n// TODO Signature?\n// Should probably be over the whole Cheque type\nmessage Cheque {\n    bytes beneficiary = 1;\n    // TODO epoch time or block time?\n    uint32 date = 2;\n    // TODO ERC20 extension?\n    // For now karma counter\n    uint32 amount = 3;\n}\n\n")),(0,o.kt)("h2",{id:"incremental-integration-and-roll-out"},"Incremental integration and roll-out"),(0,o.kt)("p",null,"To incrementally integrate this into Waku v2,\nwe have divided up the roll-out into three phases:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Soft - accounting only"),(0,o.kt)("li",{parentName:"ul"},"Mock - send mock cheques and take word for it"),(0,o.kt)("li",{parentName:"ul"},"Hard Test - blockchain integration and deployed to public testnet\n(Goerli, Optimism testnet or similar)"),(0,o.kt)("li",{parentName:"ul"},"Hard Main - deployed to a public mainnet")),(0,o.kt)("p",null,"An implementation MAY support any of these phases."),(0,o.kt)("h3",{id:"soft-phase"},"Soft phase"),(0,o.kt)("p",null,"In the soft phase only accounting is performed, without consequence for the\npeers. No disconnect or sending of cheques is performed at this tage."),(0,o.kt)("p",null,"SWAP protocol is performed in conjunction with another request-reply protocol\nto account for its usage.\nIt SHOULD be done for ",(0,o.kt)("a",{parentName:"p",href:"../../core/13/store"},"13/WAKU2-STORE"),"\nand it MAY be done for other request/reply protocols."),(0,o.kt)("p",null,"A client SHOULD log accounting state per peer\nand SHOULD indicate when a peer is out of bounds (either of its thresholds met)."),(0,o.kt)("h3",{id:"mock-phase"},"Mock phase"),(0,o.kt)("p",null,"In the mock phase, we send mock cheques and send cheques/disconnect peers as appropriate."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"If a node reaches a disconnect threshold,\nwhich MUST be outside the payment threshold, it SHOULD disconnect the other peer."),(0,o.kt)("li",{parentName:"ul"},"If a node is within payment balance, the other node SHOULD stay connected to it."),(0,o.kt)("li",{parentName:"ul"},"If a node receives a valid Cheque it SHOULD update its internal accounting records."),(0,o.kt)("li",{parentName:"ul"},"If any node behaves badly, the other node is free to disconnect and\npick another node.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Peer rating is out of scope of this specification.")))),(0,o.kt)("h3",{id:"hard-phase"},"Hard phase"),(0,o.kt)("p",null,"In the hard phase, in addition to sending cheques and activating policy, this is\ndone with blockchain integration on a public testnet. More details TBD."),(0,o.kt)("p",null,"This also includes settlements where cheques can be redeemed."),(0,o.kt)("h2",{id:"copyright"},"Copyright"),(0,o.kt)("p",null,"Copyright and related rights waived via ",(0,o.kt)("a",{parentName:"p",href:"https://creativecommons.org/publicdomain/zero/1.0/"},"CC0"),"."),(0,o.kt)("h2",{id:"references"},"References"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Prisoner%27s_dilemma"},"Prisoner's Dilemma")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/The_Evolution_of_Cooperation"},"Axelrod - Evolution of Cooperation (book)")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://web.archive.org/web/20210126130038/https://gateway.ethswarm.org/bzz/latest.bookofswarm.eth"},"Book of Swarm")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"../../core/13/store"},"13/WAKU2-STORE"))))}d.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),h=o,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||r;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);