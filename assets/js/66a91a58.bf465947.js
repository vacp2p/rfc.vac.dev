"use strict";(self.webpackChunklogos_docs_template=self.webpackChunklogos_docs_template||[]).push([[6637],{66803:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var i=a(87462),n=(a(67294),a(3905));const r={title:"33/WAKU2-DISCV5",name:"Waku v2 Discv5 Ambient Peer Discovery",status:"draft",editor:"Daniel Kaiser &lt;danielkaiser@status.im&gt;",contributors:null},o=void 0,s={unversionedId:"standards/core/33/discv5",id:"standards/core/33/discv5",title:"33/WAKU2-DISCV5",description:"- Status: draft",source:"@site/waku/standards/core/33/discv5.md",sourceDirName:"standards/core/33",slug:"/standards/core/33/discv5",permalink:"/waku/standards/core/33/discv5",draft:!1,tags:[],version:"current",frontMatter:{title:"33/WAKU2-DISCV5",name:"Waku v2 Discv5 Ambient Peer Discovery",status:"draft",editor:"Daniel Kaiser &lt;danielkaiser@status.im&gt;",contributors:null},sidebar:"defaultSidebar",previous:{title:"19/WAKU2-LIGHTPUSH",permalink:"/waku/standards/core/19/lightpush"},next:{title:"36/WAKU2-BINDINGS-API",permalink:"/waku/standards/core/36/bindings-api"}},l={},c=[{value:"Abstract",id:"abstract",level:2},{value:"Disclaimer",id:"disclaimer",level:2},{value:"Background and Rationale",id:"background-and-rationale",level:2},{value:"Separate Discovery Network",id:"separate-discovery-network",level:3},{value:"w.r.t. Waku2 Relay Network",id:"wrt-waku2-relay-network",level:4},{value:"w.r.t. Ethereum Discovery v5",id:"wrt-ethereum-discovery-v5",level:4},{value:"Semantics",id:"semantics",level:2},{value:"Wire Format Specification",id:"wire-format-specification",level:2},{value:"WAKU2-Specific <code>protocol-id</code>",id:"waku2-specific-protocol-id",level:2},{value:"Suggestions for Implementations",id:"suggestions-for-implementations",level:2},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Sybil attack",id:"sybil-attack",level:3},{value:"Eclipse attack",id:"eclipse-attack",level:3},{value:"Security Implications of a Separate Discovery Network",id:"security-implications-of-a-separate-discovery-network",level:2},{value:"References",id:"references",level:2},{value:"Copyright",id:"copyright",level:2}],d={toc:c};function p(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,i.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Status: draft"),(0,n.kt)("li",{parentName:"ul"},"Editor: Daniel Kaiser ","<",(0,n.kt)("a",{parentName:"li",href:"mailto:danielkaiser@status.im"},"danielkaiser@status.im"),">")),(0,n.kt)("h2",{id:"abstract"},"Abstract"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," specifies a modified version of\n",(0,n.kt)("a",{parentName:"p",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5"},"Ethereum's Node Discovery Protocol v5"),"\nas a means for ambient node discovery.\n",(0,n.kt)("a",{parentName:"p",href:"../10/waku2"},"10/WAKU2")," uses the ",(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," ambient node discovery network\nfor establishing a decentralized network of interconnected Waku2 nodes.\nIn its current version,\nthe ",(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," discovery network\nis isolated from the Ethereum Discovery v5 network.\nIsolation improves discovery efficiency,\nwhich is especially significant with a low number of Waku nodes\ncompared to the total number of Ethereum nodes."),(0,n.kt)("h2",{id:"disclaimer"},"Disclaimer"),(0,n.kt)("p",null,"This version of ",(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," has a focus on timely deployment\nof an efficient discovery method for ",(0,n.kt)("a",{parentName:"p",href:"../10/waku2"},"10/WAKU2"),".\nEstablishing a separate discovery network is in line with this focus.\nHowever, we are aware of potential resilience problems\n(see section on security considerations) and\nare ",(0,n.kt)("a",{parentName:"p",href:"https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8"},"discussing"),"\nand researching hybrid approaches."),(0,n.kt)("h2",{id:"background-and-rationale"},"Background and Rationale"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"../11/relay"},"11/WAKU2-RELAY")," assumes the existence of a network of Waku2 nodes.\nFor establishing and growing this network,\nnew nodes trying to join the Waku2 network need a means of discovering nodes\nwithin the network.\n",(0,n.kt)("a",{parentName:"p",href:"../10/waku2"},"10/WAKU2")," supports the following discovery methods\nin order of increasing decentralization"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"hard coded bootstrap nodes"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://rfc.vac.dev/spec/10/#discovery-domain"},(0,n.kt)("inlineCode",{parentName:"a"},"DNS discovery"))," (based on ",(0,n.kt)("a",{parentName:"li",href:"https://eips.ethereum.org/EIPS/eip-1459"},"EIP-1459"),")"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"peer-exchange")," (work in progress)"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"33/WAKU2-DISCV5")," (specified in this document)")),(0,n.kt)("p",null,"The purpose of ambient node discovery within ",(0,n.kt)("a",{parentName:"p",href:"../10/waku2"},"10/WAKU2"),"\nis discovering Waku2 nodes in a decentralized way.\nThe unique selling point of ",(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," is its holistic view of the network,\nwhich allows avoiding hotspots and allows merging the network after a split.\nWhile the other methods provide either a fixed or local set of nodes,\n",(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," can provide a random sample of Waku2 nodes.\nFuture iterations of this document will add the possibility\nof efficiently discovering Waku2 nodes that have certain capabilities,\ne.g. holding messages of a certain time frame\nduring which the querying node was offline."),(0,n.kt)("h3",{id:"separate-discovery-network"},"Separate Discovery Network"),(0,n.kt)("h4",{id:"wrt-waku2-relay-network"},"w.r.t. Waku2 Relay Network"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," spans an overlay network separate from the\n",(0,n.kt)("a",{parentName:"p",href:"https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README"},"GossipSub"),"\nnetwork ",(0,n.kt)("a",{parentName:"p",href:"../11/relay"},"11/WAKU2-RELAY")," builds on.\nBecause it is a P2P network on its own, it also depends on bootstrap nodes.\nHaving a separate discovery network reduces load on the bootstrap nodes,\nbecause the actual work is done by randomly discovered nodes.\nThis also increases decentralization."),(0,n.kt)("h4",{id:"wrt-ethereum-discovery-v5"},"w.r.t. Ethereum Discovery v5"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," spans a discovery network\nisolated from the Ethereum Discovery v5 network."),(0,n.kt)("p",null,"Another simple solution would be taking part in the Ethereum Discovery network,\nand filtering Waku nodes based on whether they support ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/waku-org/specs/blob/waku-RFC/standards/core/enr"},"WAKU2-ENR"),".\nThis solution is more resilient towards eclipse attacks.\nHowever, this discovery method is very inefficient\nfor small percentages of Waku nodes\n(see ",(0,n.kt)("a",{parentName:"p",href:"https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8"},"estimation"),").\nIt boils down to random walk discovery and does not offer a O(log(n)) hop bound.\nThe rarer the requested property (in this case Waku),\nthe longer a random walk will take until finding an appropriate node,\nwhich leads to a needle-in-the-haystack problem.\nUsing a dedicated Waku2 discovery network,\nnodes can query this discovery network for a random set of nodes\nand all (well-behaving)\nreturned nodes can serve as bootstrap nodes for other Waku2 protocols."),(0,n.kt)("p",null,"A more sophisticated solution would be using ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory##topic-advertisement"},"Discv5 topic discovery"),".\nHowever, in its current state it also has efficiency problems for small percentages\nof Waku nodes and is still in the design phase\n(",(0,n.kt)("a",{parentName:"p",href:"https://github.com/ethereum/devp2p/issues/199"},"see here"),")."),(0,n.kt)("p",null,"Currently,\nthe Ethereum discv5 network is very efficient in finding other discv5 nodes,\nbut it is not so efficient for finding discv5 nodes\nthat have a specific property or\noffer specific services, e.g. Waku."),(0,n.kt)("p",null,"As part of our ",(0,n.kt)("a",{parentName:"p",href:"https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121"},"discv5 roadmap"),",\nwe consider two ideas for future versions of ",(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory##topic-advertisement"},"Discv5 topic discovery"),"\nwith adjustments (ideally upstream)"),(0,n.kt)("li",{parentName:"ul"},"a hybrid solution that uses both a separate discv5 network and\na Waku-ENR-filtered Ethereum discv5 network")),(0,n.kt)("h2",{id:"semantics"},"Semantics"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," fully inherits the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory"},"discv5 semantics"),"."),(0,n.kt)("p",null,"Before announcing their address via Waku2 discv5,\nnodes SHOULD check if this address is publicly reachable.\nNodes MAY use the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/libp2p/specs/blob/master/autonat/README"},"libp2p AutoNAT protocol"),"\nto perform that check.\nNodes SHOULD only announce publicly reachable addresses via Waku2 discv5,\nto avoid cluttering peer lists with nodes that are not reachable."),(0,n.kt)("h2",{id:"wire-format-specification"},"Wire Format Specification"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5")," inherits the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-wire"},"discv5 wire protocol"),"\nexcept for the following differences"),(0,n.kt)("h2",{id:"waku2-specific-protocol-id"},"WAKU2-Specific ",(0,n.kt)("inlineCode",{parentName:"h2"},"protocol-id")),(0,n.kt)("p",null,"Ethereum discv5:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-text"},'header        = static-header || authdata\nstatic-header = protocol-id || version || flag || nonce || authdata-size\nprotocol-id   = <b>"discv5"</b>\nversion       = 0x0001\nauthdata-size = uint16    -- byte length of authdata\nflag          = uint8     -- packet type identifier\nnonce         = uint96    -- nonce of message\n\n')),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"33/WAKU2-DISCV5"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-text"},'kcode>\nheader        = static-header || authdata\nstatic-header = protocol-id || version || flag || nonce || authdata-size\nprotocol-id   = <b>"d5waku"</b>\nversion       = 0x0001\nauthdata-size = uint16    -- byte length of authdata\nflag          = uint8     -- packet type identifier\nnonce         = uint96    -- nonce of message\n\n')),(0,n.kt)("h2",{id:"suggestions-for-implementations"},"Suggestions for Implementations"),(0,n.kt)("p",null,"Existing discv5 implementations"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"can be augmented to make the ",(0,n.kt)("inlineCode",{parentName:"li"},"protocol-id")," selectable using a compile-time flag\nas in ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/kaiserd/nim-eth/blob/add-selectable-protocol-id-static/eth/p2p/discoveryv5/encoding.nim#L34"},"this feature branch"),"\nof nim-eth/discv5."),(0,n.kt)("li",{parentName:"ul"},"can be forked followed by changing the ",(0,n.kt)("inlineCode",{parentName:"li"},"protocol-id")," string as in ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/status-im/go-waku/blob/master/waku/v2/discv5/discover.go#L135-L137"},"go-waku"),".")),(0,n.kt)("h2",{id:"security-considerations"},"Security Considerations"),(0,n.kt)("h3",{id:"sybil-attack"},"Sybil attack"),(0,n.kt)("p",null,"Implementations should limit the number of bucket entries\nthat have the same network parameters (IP address / port) to mitigate Sybil attacks."),(0,n.kt)("h3",{id:"eclipse-attack"},"Eclipse attack"),(0,n.kt)("p",null,"Eclipse attacks aim to eclipse certain regions in a DHT.\nMalicious nodes provide false routing information for certain target regions.\nThe larger the desired eclipsed region,\nthe more resources (i.e. controlled nodes) the attacker needs.\nThis introduces an efficiency versus resilience tradeoff.\nDiscovery is more efficient if information about target objects\n(e.g. network parameters of nodes supporting Waku) are closer to a specific DHT address.\nIf nodes providing specific information are closer to each other,\nthey cover a smaller range in the DHT and are easier to eclipse."),(0,n.kt)("p",null,"Sybil attacks greatly increase the power of eclipse attacks,\nbecause they significantly reduce resources necessary\nto mount a successful eclipse attack."),(0,n.kt)("h2",{id:"security-implications-of-a-separate-discovery-network"},"Security Implications of a Separate Discovery Network"),(0,n.kt)("p",null,"A dedicated Waku discovery network is more likely to be subject\nto successful eclipse attacks (and to DoS attacks in general).\nThis is because eclipsing in a smaller network requires less resources for the attacker.\nDoS attacks render the whole network unusable\nif the percentage of attacker nodes is sufficient."),(0,n.kt)("p",null,"Using random walk discovery would mitigate eclipse attacks\ntargeted at specific capabilities, e.g. Waku.\nHowever, this is because eclipse attacks aim at the DHT overlay structure,\nwhich is not used by random walks.\nSo, this mitigation would come at the cost of giving up overlay routing efficiency.\nThe efficiency loss is especially severe with a relatively small number of Waku nodes."),(0,n.kt)("p",null,"Properly protecting against eclipse attacks is challenging and\nraises research questions that we will address in future stages of our discv5 roadmap."),(0,n.kt)("h2",{id:"references"},"References"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"../10/waku2"},"10/WAKU2")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"../11/relay"},"11/WAKU2-RELAY")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/waku-org/specs/blob/waku-RFC/standards/core/enr"},(0,n.kt)("inlineCode",{parentName:"a"},"WAKU2-ENR"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5"},"Node Discovery Protocol v5 (",(0,n.kt)("inlineCode",{parentName:"a"},"discv5"),")")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory"},(0,n.kt)("inlineCode",{parentName:"a"},"discv5")," semantics"),"."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-wire"},(0,n.kt)("inlineCode",{parentName:"a"},"discv5")," wire protocol")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory##topic-advertisement"},(0,n.kt)("inlineCode",{parentName:"a"},"discv5")," topic discovery")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://rfc.vac.dev/spec/10/#discovery-domain"},"Waku DNS discovery")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/libp2p/specs/blob/master/autonat/README"},"libp2p AutoNAT protocol")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://eips.ethereum.org/EIPS/eip-1459"},(0,n.kt)("inlineCode",{parentName:"a"},"EIP-1459"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/README"},(0,n.kt)("inlineCode",{parentName:"a"},"GossipSub"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121"},"Waku discv5 roadmap discussion")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8"},"discovery efficiency estimation")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/kaiserd/nim-eth/blob/add-selectable-protocol-id-static/eth/p2p/discoveryv5/encoding.nim"},"implementation: Nim")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/status-im/go-waku/blob/master/waku/v2/discv5/discover.go"},"implementation: Go"))),(0,n.kt)("h2",{id:"copyright"},"Copyright"),(0,n.kt)("p",null,"Copyright and related rights waived via ",(0,n.kt)("a",{parentName:"p",href:"https://creativecommons.org/publicdomain/zero/1.0/"},"CC0"),"."))}p.isMDXComponent=!0},3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var i=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,i,n=function(e,t){if(null==e)return{};var a,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=i.createContext({}),c=function(e){var t=i.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=c(e.components);return i.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(a),m=n,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||r;return a?i.createElement(h,o(o({ref:t},d),{},{components:a})):i.createElement(h,o({ref:t},d))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var c=2;c<r;c++)o[c]=a[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);