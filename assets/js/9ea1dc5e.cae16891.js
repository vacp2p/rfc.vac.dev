"use strict";(self.webpackChunklogos_docs_template=self.webpackChunklogos_docs_template||[]).push([[8539],{56577:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var i=n(87462),a=(n(67294),n(3905));const r={title:"54/WAKU2-X3DH-SESSIONS",name:"Session management for Waku X3DH",status:"draft",category:"Standards Track",editor:"Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;",contributors:["Andrea Piana &lt;andreap@status.im&gt;","Pedro Pombeiro &lt;pedro@status.im&gt;","Corey Petty &lt;corey@status.im&gt;","Oskar Thor\xe9n &lt;oskarth@titanproxy.com&gt;","Dean Eigenmann &lt;dean@status.im&gt;","Filip Dimitrijevic &lt;filip@status.im&gt;"]},s=void 0,o={unversionedId:"standards/application/54/x3dh-sessions",id:"standards/application/54/x3dh-sessions",title:"54/WAKU2-X3DH-SESSIONS",description:"- Status: draft",source:"@site/waku/standards/application/54/x3dh-sessions.md",sourceDirName:"standards/application/54",slug:"/standards/application/54/x3dh-sessions",permalink:"/waku/standards/application/54/x3dh-sessions",draft:!1,tags:[],version:"current",frontMatter:{title:"54/WAKU2-X3DH-SESSIONS",name:"Session management for Waku X3DH",status:"draft",category:"Standards Track",editor:"Aaryamann Challani &lt;p1ge0nh8er@proton.me&gt;",contributors:["Andrea Piana &lt;andreap@status.im&gt;","Pedro Pombeiro &lt;pedro@status.im&gt;","Corey Petty &lt;corey@status.im&gt;","Oskar Thor\xe9n &lt;oskarth@titanproxy.com&gt;","Dean Eigenmann &lt;dean@status.im&gt;","Filip Dimitrijevic &lt;filip@status.im&gt;"]},sidebar:"defaultSidebar",previous:{title:"53/WAKU2-X3DH",permalink:"/waku/standards/application/53/x3dh"},next:{title:"10/WAKU2",permalink:"/waku/standards/core/10/waku2"}},l={},d=[{value:"Abstract",id:"abstract",level:2},{value:"Session Establishment",id:"session-establishment",level:2},{value:"Discovery of pre-key bundles",id:"discovery-of-pre-key-bundles",level:3},{value:"Initialization",id:"initialization",level:3},{value:"Negotiated topic to be used for the session",id:"negotiated-topic-to-be-used-for-the-session",level:3},{value:"Concurrent sessions",id:"concurrent-sessions",level:3},{value:"Re-keying",id:"re-keying",level:3},{value:"Multi-device support",id:"multi-device-support",level:3},{value:"Pairing",id:"pairing",level:3},{value:"Sending messages to a paired group",id:"sending-messages-to-a-paired-group",level:3},{value:"Account recovery",id:"account-recovery",level:3},{value:"Partitioned devices",id:"partitioned-devices",level:3},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Recommendations",id:"recommendations",level:3},{value:"Copyright",id:"copyright",level:2},{value:"References",id:"references",level:2}],p={toc:d};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Status: draft"),(0,a.kt)("li",{parentName:"ul"},"Category: Standards Track"),(0,a.kt)("li",{parentName:"ul"},"Editor: Aaryamann Challani ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:p1ge0nh8er@proton.me"},"p1ge0nh8er@proton.me"),">"),(0,a.kt)("li",{parentName:"ul"},"Contributors:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Andrea Piana ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:andreap@status.im"},"andreap@status.im"),">"),(0,a.kt)("li",{parentName:"ul"},"Pedro Pombeiro ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:pedro@status.im"},"pedro@status.im"),">"),(0,a.kt)("li",{parentName:"ul"},"Corey Petty ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:corey@status.im"},"corey@status.im"),">"),(0,a.kt)("li",{parentName:"ul"},"Oskar Thor\xe9n ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:oskarth@titanproxy.com"},"oskarth@titanproxy.com"),">"),(0,a.kt)("li",{parentName:"ul"},"Dean Eigenmann ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:dean@status.im"},"dean@status.im"),">"),(0,a.kt)("li",{parentName:"ul"},"Filip Dimitrijevic ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:filip@status.im"},"filip@status.im"),">")))),(0,a.kt)("h2",{id:"abstract"},"Abstract"),(0,a.kt)("p",null,"This document specifies how to manage sessions based on an X3DH key exchange.\nThis includes how to establish new sessions,\nhow to re-establish them, how to maintain them, and how to close them."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/waku/standards/application/53/x3dh"},"53/WAKU2-X3DH")," specifies the Waku ",(0,a.kt)("inlineCode",{parentName:"p"},"X3DH")," protocol\nfor end-to-end encryption.\nOnce two peers complete an X3DH handshake, they SHOULD establish an X3DH session."),(0,a.kt)("h2",{id:"session-establishment"},"Session Establishment"),(0,a.kt)("p",null,"A node identifies a peer by their ",(0,a.kt)("inlineCode",{parentName:"p"},"installation-id"),"\nwhich MAY be interpreted as a device identifier."),(0,a.kt)("h3",{id:"discovery-of-pre-key-bundles"},"Discovery of pre-key bundles"),(0,a.kt)("p",null,"The node's pre-key bundle MUST be broadcast on a content topic\nderived from the node's public key, so that the first message may be PFS-encrypted.\nEach peer MUST publish their pre-key bundle periodically to this topic,\notherwise they risk not being able to perform key-exchanges with other peers.\nEach peer MAY publish to this topic when their metadata changes,\nso that the other peer can update their local record."),(0,a.kt)("p",null,"If peer A wants to send a message to peer B,\nit MUST derive the topic from peer B's public key, which has been shared out of band.\nPartitioned topics have been used to balance privacy and\nefficiency of broadcasting pre-key bundles."),(0,a.kt)("p",null,"The number of partitions that MUST be used is 5000."),(0,a.kt)("p",null,"The topic MUST be derived as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'var partitionsNum *big.Int = big.NewInt(5000)\nvar partition *big.Int = big.NewInt(0).Mod(peerBPublicKey, partitionsNum)\n\npartitionTopic := "contact-discovery-" + strconv.FormatInt(partition.Int64(), 10)\n\nvar hash []byte = keccak256(partitionTopic)\nvar topicLen int = 4\n\nif len(hash) < topicLen {\n    topicLen = len(hash)\n}\n\nvar contactCodeTopic [4]byte\nfor i = 0; i < topicLen; i++ {\n    contactCodeTopic[i] = hash[i]\n}\n')),(0,a.kt)("h3",{id:"initialization"},"Initialization"),(0,a.kt)("p",null,"A node initializes a new session once a successful X3DH exchange has taken place.\nSubsequent messages will use the established session until re-keying is necessary."),(0,a.kt)("h3",{id:"negotiated-topic-to-be-used-for-the-session"},"Negotiated topic to be used for the session"),(0,a.kt)("p",null,"After the peers have performed the initial key exchange,\nthey MUST derive a topic from their shared secret to send messages on.\nTo obtain this value, take the first four bytes of the keccak256 hash\nof the shared secret encoded in hexadecimal format."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"sharedKey, err := ecies.ImportECDSA(myPrivateKey).GenerateShared(\n    ecies.ImportECDSAPublic(theirPublicKey),\n    16,\n    16,\n)\n\nhexEncodedKey := hex.EncodeToString(sharedKey)\n\nvar hash []byte = keccak256(hexEncodedKey)\nvar topicLen int = 4\n\nif len(hash) < topicLen {\n    topicLen = len(hash)\n}\n\nvar topic [4]byte\nfor i = 0; i < topicLen; i++ {\n    topic[i] = hash[i]\n}\n")),(0,a.kt)("p",null,"To summarize,\nfollowing is the process for peer B to establish a session with peer A:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Listen to peer B's Contact Code Topic to retrieve their bundle information,\nincluding a list of active devices"),(0,a.kt)("li",{parentName:"ol"},"Peer A sends their pre-key bundle on peer B's partitioned topic"),(0,a.kt)("li",{parentName:"ol"},"Peer A and peer B perform the key-exchange using the shared pre-key bundles"),(0,a.kt)("li",{parentName:"ol"},"The negotiated topic is derived from the shared secret"),(0,a.kt)("li",{parentName:"ol"},"Peers A & B exchange messages on the negotiated topic")),(0,a.kt)("h3",{id:"concurrent-sessions"},"Concurrent sessions"),(0,a.kt)("p",null,"If a node creates two sessions concurrently between two peers,\nthe one with the symmetric key first in byte order SHOULD be used,\nthis marks that the other has expired."),(0,a.kt)("h3",{id:"re-keying"},"Re-keying"),(0,a.kt)("p",null,"On receiving a bundle from a given peer with a higher version,\nthe old bundle SHOULD be marked as expired and\na new session SHOULD be established on the next message sent."),(0,a.kt)("h3",{id:"multi-device-support"},"Multi-device support"),(0,a.kt)("p",null,"Multi-device support is quite challenging\nas there is not a central place where information on which and how many devices\n(identified by their respective ",(0,a.kt)("inlineCode",{parentName:"p"},"installation-id"),") a peer has, is stored."),(0,a.kt)("p",null,"Furthermore, account recovery always needs to be taken into consideration,\nwhere a user wipes clean the whole device and\nthe node loses all the information about any previous sessions.\nTaking these considerations into account,\nthe way the network propagates multi-device information using X3DH bundles,\nwhich will contain information about paired devices\nas well as information about the sending device.\nThis means that every time a new device is paired,\nthe bundle needs to be updated and propagated with the new information,\nthe user has the responsibility to make sure the pairing is successful."),(0,a.kt)("p",null,"The method is loosely based on ",(0,a.kt)("a",{parentName:"p",href:"https://signal.org/docs/specifications/sesame/"},"Signal's Sesame Algorithm"),"."),(0,a.kt)("h3",{id:"pairing"},"Pairing"),(0,a.kt)("p",null,"A new ",(0,a.kt)("inlineCode",{parentName:"p"},"installation-id")," MUST be generated on a per-device basis.\nThe device should be paired as soon as possible if other devices are present."),(0,a.kt)("p",null,"If a bundle is received, which has the same ",(0,a.kt)("inlineCode",{parentName:"p"},"IK")," as the keypair present on the device,\nthe devices MAY be paired.\nOnce a user enables a new device,\na new bundle MUST be generated which includes pairing information."),(0,a.kt)("p",null,"The bundle MUST be propagated to contacts through the usual channels."),(0,a.kt)("p",null,"Removal of paired devices is a manual step that needs to be applied on each device,\nand consist simply in disabling the device,\nat which point pairing information will not be propagated anymore."),(0,a.kt)("h3",{id:"sending-messages-to-a-paired-group"},"Sending messages to a paired group"),(0,a.kt)("p",null,"When sending a message,\nthe peer SHOULD send a message to other ",(0,a.kt)("inlineCode",{parentName:"p"},"installation-id")," that they have seen.\nThe node caps the number of devices to ",(0,a.kt)("inlineCode",{parentName:"p"},"n"),", ordered by last activity.\nThe node sends messages using pairwise encryption, including their own devices."),(0,a.kt)("p",null,"Where ",(0,a.kt)("inlineCode",{parentName:"p"},"n")," is the maximum number of devices that can be paired."),(0,a.kt)("h3",{id:"account-recovery"},"Account recovery"),(0,a.kt)("p",null,"Account recovery is the same as adding a new device,\nand it MUST be handled the same way."),(0,a.kt)("h3",{id:"partitioned-devices"},"Partitioned devices"),(0,a.kt)("p",null,"In some cases\n(i.e. account recovery when no other pairing device is available, device not paired),\nit is possible that a device will receive a message\nthat is not targeted to its own ",(0,a.kt)("inlineCode",{parentName:"p"},"installation-id"),".\nIn this case an empty message containing bundle information MUST be sent back,\nwhich will notify the receiving end not to include the device in any further communication."),(0,a.kt)("h2",{id:"security-considerations"},"Security Considerations"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Inherits all security considerations from ",(0,a.kt)("a",{parentName:"li",href:"/waku/standards/application/53/x3dh"},"53/WAKU2-X3DH"),".")),(0,a.kt)("h3",{id:"recommendations"},"Recommendations"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The value of ",(0,a.kt)("inlineCode",{parentName:"li"},"n")," SHOULD be configured by the app-protocol.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"The default value SHOULD be 3,\nsince a larger number of devices will result in a larger bundle size,\nwhich may not be desirable in a peer-to-peer network.")))),(0,a.kt)("h2",{id:"copyright"},"Copyright"),(0,a.kt)("p",null,"Copyright and related rights waived via\n",(0,a.kt)("a",{parentName:"p",href:"https://creativecommons.org/publicdomain/zero/1.0/"},"CC0"),"."),(0,a.kt)("h2",{id:"references"},"References"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/waku/standards/application/53/x3dh"},"53/WAKU2-X3DH")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://signal.org/docs/specifications/sesame/"},"Signal's Sesame Algorithm"))))}c.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>u});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=i.createContext({}),d=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=d(e.components);return i.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),h=d(n),u=a,m=h["".concat(l,".").concat(u)]||h[u]||c[u]||r;return n?i.createElement(m,s(s({ref:t},p),{},{components:n})):i.createElement(m,s({ref:t},p))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,s=new Array(r);s[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var d=2;d<r;d++)s[d]=n[d];return i.createElement.apply(null,s)}return i.createElement.apply(null,n)}h.displayName="MDXCreateElement"}}]);