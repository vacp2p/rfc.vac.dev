"use strict";(self.webpackChunklogos_docs_template=self.webpackChunklogos_docs_template||[]).push([[748],{35137:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>p});var i=n(87462),a=(n(67294),n(3905));const o={title:"PUSH-NOTIFICATION-SERVER",name:"Push notification server",status:"deprecated",description:"Status provides a set of Push notification services that can be used to achieve this functionality.",editor:"Filip Dimitrijevic &lt;filip@status.im&gt;",contributors:["Andrea Maria Piana &lt;andreap@status.im&gt;"]},s=void 0,r={unversionedId:"deprecated/push-notification-server",id:"deprecated/push-notification-server",title:"PUSH-NOTIFICATION-SERVER",description:"Status provides a set of Push notification services that can be used to achieve this functionality.",source:"@site/status/deprecated/push-notification-server.md",sourceDirName:"deprecated",slug:"/deprecated/push-notification-server",permalink:"/status/deprecated/push-notification-server",draft:!1,tags:[],version:"current",frontMatter:{title:"PUSH-NOTIFICATION-SERVER",name:"Push notification server",status:"deprecated",description:"Status provides a set of Push notification services that can be used to achieve this functionality.",editor:"Filip Dimitrijevic &lt;filip@status.im&gt;",contributors:["Andrea Maria Piana &lt;andreap@status.im&gt;"]},sidebar:"defaultSidebar",previous:{title:"PAYLOADS",permalink:"/status/deprecated/payloads"},next:{title:"SECURE-TRANSPORT",permalink:"/status/deprecated/secure-transport"}},l={},p=[{value:"Reason",id:"reason",level:2},{value:"Requirements",id:"requirements",level:2},{value:"Components",id:"components",level:2},{value:"Gorush instance",id:"gorush-instance",level:3},{value:"Push notification server",id:"push-notification-server",level:3},{value:"Registering client",id:"registering-client",level:3},{value:"Sending client",id:"sending-client",level:3},{value:"Registering with the push notification service",id:"registering-with-the-push-notification-service",level:2},{value:"Query topic",id:"query-topic",level:3},{value:"Server grant",id:"server-grant",level:3},{value:"Re-registering with the push notification server",id:"re-registering-with-the-push-notification-server",level:2},{value:"Changing options",id:"changing-options",level:2},{value:"Unregistering from push notifications",id:"unregistering-from-push-notifications",level:2},{value:"Advertising a push notification server",id:"advertising-a-push-notification-server",level:2},{value:"Discovering a push notification server",id:"discovering-a-push-notification-server",level:2},{value:"Querying the push notification server",id:"querying-the-push-notification-server",level:2},{value:"Sending a push notification",id:"sending-a-push-notification",level:2},{value:"Flow",id:"flow",level:2},{value:"Registration process",id:"registration-process",level:3},{value:"Sending a notification",id:"sending-a-notification",level:3},{value:"Receiving a push notification",id:"receiving-a-push-notification",level:3},{value:"Protobuf description",id:"protobuf-description",level:2},{value:"PushNotificationRegistration",id:"pushnotificationregistration",level:3},{value:"Data disclosed",id:"data-disclosed",level:4},{value:"PushNotificationRegistrationResponse",id:"pushnotificationregistrationresponse",level:3},{value:"ContactCodeAdvertisement",id:"contactcodeadvertisement",level:3},{value:"PushNotificationQuery",id:"pushnotificationquery",level:3},{value:"PushNotificationQueryInfo",id:"pushnotificationqueryinfo",level:3},{value:"PushNotificationQueryResponse",id:"pushnotificationqueryresponse",level:3},{value:"PushNotification",id:"pushnotification",level:3},{value:"PushNotificationRequest",id:"pushnotificationrequest",level:3},{value:"PushNotificationResponse",id:"pushnotificationresponse",level:3},{value:"PushNotificationReport",id:"pushnotificationreport",level:3},{value:"Anonymous mode of operations",id:"anonymous-mode-of-operations",level:2},{value:"Security considerations",id:"security-considerations",level:2},{value:"FAQ",id:"faq",level:2},{value:"Why having ACL done at the server side and not the client?",id:"why-having-acl-done-at-the-server-side-and-not-the-client",level:3},{value:"Why using an access token?",id:"why-using-an-access-token",level:3},{value:"Why advertise with the bundle?",id:"why-advertise-with-the-bundle",level:3},{value:"What&#39;s the  bandwidth impact for this?",id:"whats-the--bandwidth-impact-for-this",level:3},{value:"What&#39;s the information disclosed?",id:"whats-the-information-disclosed",level:3},{value:"What prevents a user from generating a random key and getting an access token and spamming?",id:"what-prevents-a-user-from-generating-a-random-key-and-getting-an-access-token-and-spamming",level:3},{value:"Why not 0-knowledge proofs/quantum computing",id:"why-not-0-knowledge-proofsquantum-computing",level:3},{value:"How to handle backward/forward compatibility",id:"how-to-handle-backwardforward-compatibility",level:3},{value:"Why ack_key?",id:"why-ack_key",level:3},{value:"Can I run my own node?",id:"can-i-run-my-own-node",level:3},{value:"Can I register with multiple nodes for redundancy",id:"can-i-register-with-multiple-nodes-for-redundancy",level:3},{value:"What does my node disclose?",id:"what-does-my-node-disclose",level:3},{value:"Does this have high-reliability requirements?",id:"does-this-have-high-reliability-requirements",level:3},{value:"Can someone else (i.e not status) run this?",id:"can-someone-else-ie-not-status-run-this",level:3},{value:"Changelog",id:"changelog",level:2},{value:"Version 0.1",id:"version-01",level:3},{value:"Copyright",id:"copyright",level:2},{value:"References",id:"references",level:2}],d={toc:p};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Status: deprecated"),(0,a.kt)("li",{parentName:"ul"},"Editor: Filip Dimitrijevic ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:filip@status.im"},"filip@status.im"),">"),(0,a.kt)("li",{parentName:"ul"},"Contributors:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Andrea Maria Piana ","<",(0,a.kt)("a",{parentName:"li",href:"mailto:andreap@status.im"},"andreap@status.im"),">")))),(0,a.kt)("h2",{id:"reason"},"Reason"),(0,a.kt)("p",null,"Push notifications for iOS devices and some Android devices can only be implemented by relying on ",(0,a.kt)("a",{parentName:"p",href:"https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1"},"APN service")," for iOS or ",(0,a.kt)("a",{parentName:"p",href:"https://firebase.google.com/"},"Firebase"),"."),(0,a.kt)("p",null,"This is useful for Android devices that do not support foreground services\nor that often kill the foreground service."),(0,a.kt)("p",null,"iOS only allows certain kind of applications to keep a connection open when in the\nbackground, VoIP for example, which current status client does not qualify for."),(0,a.kt)("p",null,"Applications on iOS can also request execution time when they are in the ",(0,a.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/uikit/app_and_environment/scenes/preparing_your_ui_to_run_in_the_background/updating_your_app_with_background_app_refresh"},"background"),"\nbut it has a limited set of use cases, for example it won't schedule any time\nif the application was force quit,\nand generally is not responsive enough to implement a push notification system."),(0,a.kt)("p",null,"Therefore Status provides a set of Push notification services\nthat can be used to achieve this functionality."),(0,a.kt)("p",null,"Because this can't be safely implemented in a privacy preserving manner,\nclients MUST be given an option to opt-in to receiving and sending push notifications.\nThey are disabled by default."),(0,a.kt)("h2",{id:"requirements"},"Requirements"),(0,a.kt)("p",null,"The party releasing the app MUST possess a certificate for the Apple Push Notification service\nand its has to run a ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/appleboy/gorush"},"gorush")," publicly accessible server for sending the actual notification.\nThe party releasing the app, Status in this case, needs to run its own ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/appleboy/gorush"},"gorush")),(0,a.kt)("h2",{id:"components"},"Components"),(0,a.kt)("h3",{id:"gorush-instance"},"Gorush instance"),(0,a.kt)("p",null,"A ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/appleboy/gorush"},"gorush")," instance MUST be publicly available,\nthis will be used only by push notification servers."),(0,a.kt)("h3",{id:"push-notification-server"},"Push notification server"),(0,a.kt)("p",null,"A push notification server used by clients to register for receiving and sending push notifications."),(0,a.kt)("h3",{id:"registering-client"},"Registering client"),(0,a.kt)("p",null,"A Status client that wants to receive push notifications"),(0,a.kt)("h3",{id:"sending-client"},"Sending client"),(0,a.kt)("p",null,"A Status client that wants to send push notifications"),(0,a.kt)("h2",{id:"registering-with-the-push-notification-service"},"Registering with the push notification service"),(0,a.kt)("p",null,"A client MAY register with one or more Push Notification services of their choice."),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"PNR message")," (Push Notification Registration) MUST be sent to the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/waku-usage/#partitioned-topic"},"partitioned topic"),"\nfor the public key of the node, encrypted with this key."),(0,a.kt)("p",null,"The message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/payload/#payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_REGISTRATION"),"."),(0,a.kt)("p",null,"The marshaled protobuf payload MUST also be encrypted with AES-GCM\nusing the Diffie\u2013Hellman key generated from the client and server identity."),(0,a.kt)("p",null,"This is done in order to ensure that the extracted key from the signature will be\nconsidered invalid if it can't decrypt the payload."),(0,a.kt)("p",null,"The content of the message MUST contain the following ",(0,a.kt)("a",{parentName:"p",href:"https://developers.google.com/protocol-buffers/"},"protobuf record"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotificationRegistration {\n  enum TokenType {\n    UNKNOWN_TOKEN_TYPE = 0;\n    APN_TOKEN = 1;\n    FIREBASE_TOKEN = 2;\n  }\n  TokenType token_type = 1;\n  string device_token = 2;\n  string installation_id = 3;\n  string access_token = 4;\n  bool enabled = 5;\n  uint64 version = 6;\n  repeated bytes allowed_key_list = 7;\n  repeated bytes blocked_chat_list = 8;\n  bool unregister = 9;\n  bytes grant = 10;\n  bool allow_from_contacts_only = 11;\n  string apn_topic = 12;\n  bool block_mentions = 13;\n  repeated bytes allowed_mentions_chat_list = 14;\n}\n")),(0,a.kt)("p",null,"A push notification server will handle the message according to the following rules:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"it MUST extract the public key of the sender from the signature and verify that\nthe payload can be decrypted successfully."),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"token_type")," is supported"),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"device_token")," is non empty"),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"installation_id")," is non empty"),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"version")," is non-zero and greater than the currently stored version for the public key and installation id of the sender, if any"),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"grant")," is non empty and according to the ",(0,a.kt)("a",{parentName:"li",href:"#server-grant"},"specs")),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"access_token")," is a valid ",(0,a.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/rfc4122"},(0,a.kt)("inlineCode",{parentName:"a"},"uuid"))),(0,a.kt)("li",{parentName:"ul"},"it MUST verify that ",(0,a.kt)("inlineCode",{parentName:"li"},"apn_topic")," is set if ",(0,a.kt)("inlineCode",{parentName:"li"},"token_type")," is ",(0,a.kt)("inlineCode",{parentName:"li"},"APN_TOKEN"))),(0,a.kt)("p",null,"If the message can't be decrypted, the message MUST be discarded."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"token_type")," is not supported, a response MUST be sent with ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," set to\n",(0,a.kt)("inlineCode",{parentName:"p"},"UNSUPPORTED_TOKEN_TYPE"),"."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"token"),",",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id"),",",(0,a.kt)("inlineCode",{parentName:"p"},"device_tokens"),",",(0,a.kt)("inlineCode",{parentName:"p"},"version")," are empty, a response MUST\nbe sent with ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," set to ",(0,a.kt)("inlineCode",{parentName:"p"},"MALFORMED_MESSAGE"),"."),(0,a.kt)("p",null,"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"version")," is equal or less than the currently stored version, a response MUST\nbe sent with ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," set to ",(0,a.kt)("inlineCode",{parentName:"p"},"VERSION_MISMATCH"),"."),(0,a.kt)("p",null,"If any other error occurs the ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," should be set to ",(0,a.kt)("inlineCode",{parentName:"p"},"INTERNAL_ERROR"),"."),(0,a.kt)("p",null,"If the response is successful ",(0,a.kt)("inlineCode",{parentName:"p"},"success")," MUST be set to ",(0,a.kt)("inlineCode",{parentName:"p"},"true")," otherwise a response MUST be sent with ",(0,a.kt)("inlineCode",{parentName:"p"},"success")," set to ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),"."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"request_id")," should be set to the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the encrypted payload."),(0,a.kt)("p",null,"The response MUST be sent on the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/waku-usage##partitioned-topic"},"partitioned topic")," of the sender\nand MUST not be encrypted using the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/secure-transport"},"secure transport")," to facilitate the usage of ephemeral keys."),(0,a.kt)("p",null,"The payload of the response is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotificationRegistrationResponse {\n  bool success = 1;\n  ErrorType error = 2;\n  bytes request_id = 3;\n\n  enum ErrorType {\n    UNKNOWN_ERROR_TYPE = 0;\n    MALFORMED_MESSAGE = 1;\n    VERSION_MISMATCH = 2;\n    UNSUPPORTED_TOKEN_TYPE = 3;\n    INTERNAL_ERROR = 4;\n  }\n}\n")),(0,a.kt)("p",null,"The message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/payloads##payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_REGISTRATION_RESPONSE"),"."),(0,a.kt)("p",null,"A client SHOULD listen for a response sent on the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/waku-usage/#partitioned-topic"},"partitioned topic"),"\nthat the key used to register."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"success")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"true")," the client has registered successfully."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"success")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),":"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"MALFORMED_MESSAGE")," is returned, the request SHOULD NOT be retried without ensuring that it is correctly formed."),(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"INTERNAL_ERROR")," is returned, the request MAY be retried, but the client MUST backoff exponentially")),(0,a.kt)("p",null,"A client MAY register with multiple Push Notification Servers in order to increase availability."),(0,a.kt)("p",null,"A client SHOULD make sure that all the notification services they registered with have the same information about their tokens."),(0,a.kt)("p",null,"If no response is returned the request SHOULD be considered failed and MAY be retried with the same server or a different one, but clients MUST exponentially backoff after each trial."),(0,a.kt)("p",null,"If the request is successful the token SHOULD be ",(0,a.kt)("a",{parentName:"p",href:"#advertising-a-push-notification-server"},"advertised")," as described below"),(0,a.kt)("h3",{id:"query-topic"},"Query topic"),(0,a.kt)("p",null,"On successful registration the server MUST be listening to the topic derived from:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"   0XHexEncode(Shake256(CompressedClientPublicKey))\n")),(0,a.kt)("p",null,"Using the topic derivation algorithm described ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/waku-usage/#public-chats"},"here"),"\nand listen for client queries."),(0,a.kt)("h3",{id:"server-grant"},"Server grant"),(0,a.kt)("p",null,"A push notification server needs to demonstrate to a client that it was authorized\nby the client to send them push notifications. This is done by building\na grant which is specific to a given client-server pair.\nThe grant is built as follow:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"   Signature(Keccak256(CompressedPublicKeyOfClient . CompressedPublicKeyOfServer . AccessToken), PrivateKeyOfClient)\n")),(0,a.kt)("p",null,"When receiving a grant the server MUST be validate that the signature matches the registering client."),(0,a.kt)("h2",{id:"re-registering-with-the-push-notification-server"},"Re-registering with the push notification server"),(0,a.kt)("p",null,"A client SHOULD re-register with the node if the APN or FIREBASE token changes."),(0,a.kt)("p",null,"When re-registering a client SHOULD ensure that it has the most up-to-date\n",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationRegistration")," and increment ",(0,a.kt)("inlineCode",{parentName:"p"},"version")," if necessary."),(0,a.kt)("p",null,"Once re-registered, a client SHOULD advertise the changes."),(0,a.kt)("h2",{id:"changing-options"},"Changing options"),(0,a.kt)("p",null,"This is handled in exactly the same way as re-registering above."),(0,a.kt)("h2",{id:"unregistering-from-push-notifications"},"Unregistering from push notifications"),(0,a.kt)("p",null,"To unregister a client MUST send a ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationRegistration")," request as described\nabove with ",(0,a.kt)("inlineCode",{parentName:"p"},"unregister")," set to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),", or removing\ntheir device information."),(0,a.kt)("p",null,"The server MUST remove all data about this user if ",(0,a.kt)("inlineCode",{parentName:"p"},"unregistering")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),",\napart from the ",(0,a.kt)("inlineCode",{parentName:"p"},"hash")," of the public key and the ",(0,a.kt)("inlineCode",{parentName:"p"},"version")," of the last options,\nin order to make sure that old messages are not processed."),(0,a.kt)("p",null,"A client MAY unregister from a server on explicit logout if multiple chat keys\nare used on a single device."),(0,a.kt)("h2",{id:"advertising-a-push-notification-server"},"Advertising a push notification server"),(0,a.kt)("p",null,"Each user registered with one or more push notification servers SHOULD\nadvertise periodically the push notification services that they have registered with for each device they own."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotificationQueryInfo {\n  string access_token = 1;\n  string installation_id = 2;\n  bytes public_key = 3;\n  repeated bytes allowed_user_list = 4;\n  bytes grant = 5;\n  uint64 version = 6;\n  bytes server_public_key = 7;\n}\n\nmessage ContactCodeAdvertisement {\n  repeated PushNotificationQueryInfo push_notification_info = 1;\n}\n")),(0,a.kt)("p",null,"The message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/payloads/#payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_QUERY_INFO"),"."),(0,a.kt)("p",null,"If no filtering is done based on public keys,\nthe access token SHOULD be included in the advertisement.\nOtherwise it SHOULD be left empty."),(0,a.kt)("p",null,"This SHOULD be advertised on the ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/waku-usage##contact-code-topic"},"contact code topic"),"\nand SHOULD be coupled with normal contact-code advertisement."),(0,a.kt)("p",null,"Every time a user register or re-register with a push notification service, their\ncontact-code SHOULD be re-advertised."),(0,a.kt)("p",null,"Multiple servers MAY be advertised for the same ",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id")," for redundancy reasons."),(0,a.kt)("h2",{id:"discovering-a-push-notification-server"},"Discovering a push notification server"),(0,a.kt)("p",null,"To discover a push notification service for a given user, their ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/waku-usage/#contact-code-topic"},"contact code topic"),"\nSHOULD be listened to.\nA mailserver can be queried for the specific topic to retrieve the most up-to-date\ncontact code."),(0,a.kt)("h2",{id:"querying-the-push-notification-server"},"Querying the push notification server"),(0,a.kt)("p",null,"If a token is not present in the latest advertisement for a user, the server\nSHOULD be queried directly."),(0,a.kt)("p",null,"To query a server a message:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotificationQuery {\n  repeated bytes public_keys = 1;\n}\n")),(0,a.kt)("p",null,"The message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/payloads/#payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_QUERY"),"."),(0,a.kt)("p",null,"MUST be sent to the server on the topic derived from the hashed public key of the\nkey we are querying, as ",(0,a.kt)("a",{parentName:"p",href:"#query-topic"},"described above"),"."),(0,a.kt)("p",null,"An ephemeral key SHOULD be used and SHOULD NOT be encrypted using the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/secure-transport"},"secure transport"),"."),(0,a.kt)("p",null,"If the server has information about the client a response MUST be sent:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotificationQueryInfo {\n  string access_token = 1;\n  string installation_id = 2;\n  bytes public_key = 3;\n  repeated bytes allowed_user_list = 4;\n  bytes grant = 5;\n  uint64 version = 6;\n  bytes server_public_key = 7;\n}\n\nmessage PushNotificationQueryResponse {\n  repeated PushNotificationQueryInfo info = 1;\n  bytes message_id = 2;\n  bool success = 3;\n}\n")),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationQueryResponse")," message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/payloads##payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_QUERY_RESPONSE"),"."),(0,a.kt)("p",null,"Otherwise a response MUST NOT be sent."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list")," is not set ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token")," MUST be set and ",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list")," MUST NOT\nbe set."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list")," is set ",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list")," MUST be set and ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token")," MUST NOT be set."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token")," is returned, the ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token")," SHOULD be used to send push notifications."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list")," are returned, the client SHOULD decrypt each\ntoken by generating an ",(0,a.kt)("inlineCode",{parentName:"p"},"AES-GCM")," symmetric key from the Diffie\u2013Hellman between the\ntarget client and itself\nIf AES decryption succeeds it will return a valid ",(0,a.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc4122"},(0,a.kt)("inlineCode",{parentName:"a"},"uuid"))," which is what is used for access_token.\nThe token SHOULD be used to send push notifications."),(0,a.kt)("p",null,"The response MUST be sent on the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/waku-usage/#partitioned-topic"},"partitioned topic")," of the sender\nand MUST not be encrypted using the ",(0,a.kt)("a",{parentName:"p",href:"status/deprecated/secure-transport"},"secure transport")," to facilitate\nthe usage of ephemeral keys."),(0,a.kt)("p",null,"On receiving a response a client MUST verify ",(0,a.kt)("inlineCode",{parentName:"p"},"grant")," to ensure that the server\nhas been authorized to send push notification to a given client."),(0,a.kt)("h2",{id:"sending-a-push-notification"},"Sending a push notification"),(0,a.kt)("p",null,"When sending a push notification, only the ",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id")," for the devices targeted\nby the message SHOULD be used."),(0,a.kt)("p",null,"If a message is for all the user devices, all the ",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id")," known to the client MAY be used."),(0,a.kt)("p",null,"The number of devices MAY be capped in order to reduce resource consumption."),(0,a.kt)("p",null,"At least 3 devices SHOULD be targeted, ordered by last activity."),(0,a.kt)("p",null,"For any device that a token is available, or that a token is successfully queried,\na push notification message SHOULD be sent to the corresponding push notification server."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotification {\n  string access_token = 1;\n  string chat_id = 2;\n  bytes public_key = 3;\n  string installation_id = 4;\n  bytes message = 5;\n  PushNotificationType type = 6;\n  enum PushNotificationType {\n    UNKNOWN_PUSH_NOTIFICATION_TYPE = 0;\n    MESSAGE = 1;\n    MENTION = 2;\n  }\n  bytes author = 7;\n}\n\nmessage PushNotificationRequest {\n  repeated PushNotification requests = 1;\n  bytes message_id = 2;\n}\n")),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationRequest")," message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/payloads##payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_REQUEST"),"."),(0,a.kt)("p",null,"Where ",(0,a.kt)("inlineCode",{parentName:"p"},"message")," is the encrypted payload of the message and ",(0,a.kt)("inlineCode",{parentName:"p"},"chat_id")," is the\n",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the ",(0,a.kt)("inlineCode",{parentName:"p"},"chat_id"),".\n",(0,a.kt)("inlineCode",{parentName:"p"},"message_id")," is the id of the message\n",(0,a.kt)("inlineCode",{parentName:"p"},"author")," is the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the public key of the sender."),(0,a.kt)("p",null,"If multiple server are available for a given push notification, only one notification\nMUST be sent."),(0,a.kt)("p",null,"If no response is received\na client SHOULD wait at least 3 seconds, after which the request MAY be retried against a different server"),(0,a.kt)("p",null,"This message SHOULD be sent using an ephemeral key."),(0,a.kt)("p",null,"On receiving the message, the push notification server MUST validate the access token.\nIf the access token is valid, a notification MUST be sent to the gorush instance with the\nfollowing data:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'{\n  "notifications": [\n    {\n      "tokens": ["token_a", "token_b"],\n      "platform": 1,\n      "message": "You have a new message",\n      "data": {\n        "chat_id": chat_id,\n        "message": message,\n        "installation_ids": [installation_id_1, installation_id_2]\n      }\n    }\n  ]\n}\n')),(0,a.kt)("p",null,"Where platform is ",(0,a.kt)("inlineCode",{parentName:"p"},"1")," for IOS and ",(0,a.kt)("inlineCode",{parentName:"p"},"2")," for Firebase, according to the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/appleboy/gorush"},"gorush documentation")),(0,a.kt)("p",null,"A server MUST return a response message:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},"message PushNotificationReport {\n  bool success = 1;\n  ErrorType error = 2;\n  enum ErrorType {\n    UNKNOWN_ERROR_TYPE = 0;\n    WRONG_TOKEN = 1;\n    INTERNAL_ERROR = 2;\n    NOT_REGISTERED = 3;\n  }\n  bytes public_key = 3;\n  string installation_id = 4;\n}\n\nmessage PushNotificationResponse {\n  bytes message_id = 1;\n  repeated PushNotificationReport reports = 2;\n}\n")),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationResponse")," message MUST be wrapped in a ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/payloads##payload-wrapper"},(0,a.kt)("inlineCode",{parentName:"a"},"ApplicationMetadataMessage"))," with type set to ",(0,a.kt)("inlineCode",{parentName:"p"},"PUSH_NOTIFICATION_RESPONSE"),"."),(0,a.kt)("p",null,"Where ",(0,a.kt)("inlineCode",{parentName:"p"},"message_id")," is the ",(0,a.kt)("inlineCode",{parentName:"p"},"message_id")," sent by the client."),(0,a.kt)("p",null,"The response MUST be sent on the ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/waku-usage##partitioned-topic"},"partitioned topic")," of the sender\nand MUST not be encrypted using the ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/secure-transport"},"secure transport")," to facilitate\nthe usage of ephemeral keys."),(0,a.kt)("p",null,"If the request is accepted ",(0,a.kt)("inlineCode",{parentName:"p"},"success")," MUST be set to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),".\nOtherwise ",(0,a.kt)("inlineCode",{parentName:"p"},"success")," MUST be set to ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),"."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"BAD_TOKEN")," the client MAY query again the server for the token and\nretry the request."),(0,a.kt)("p",null,"If ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"INTERNAL_ERROR")," the client MAY retry the request."),(0,a.kt)("h2",{id:"flow"},"Flow"),(0,a.kt)("h3",{id:"registration-process"},"Registration process"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A client will generate a notification token through ",(0,a.kt)("inlineCode",{parentName:"li"},"APN")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"Firebase"),"."),(0,a.kt)("li",{parentName:"ul"},"The client will ",(0,a.kt)("a",{parentName:"li",href:"#registering-with-the-push-notification-service"},"register")," with one or more push notification server of their choosing."),(0,a.kt)("li",{parentName:"ul"},"The server should process the response and respond according to the success of the operation"),(0,a.kt)("li",{parentName:"ul"},"If the request is not successful it might be retried, and adjusted according to the response. A different server can be also used."),(0,a.kt)("li",{parentName:"ul"},"Once the request is successful the client should ",(0,a.kt)("a",{parentName:"li",href:"#advertising-a-push-notification-server"},"advertise")," the new coordinates")),(0,a.kt)("h3",{id:"sending-a-notification"},"Sending a notification"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A client should prepare a message and extract the targeted installation-ids"),(0,a.kt)("li",{parentName:"ul"},"It should retrieve the most up to date information for a given user, either by\nquerying a push notification server, a mailserver if not listening already to the given topic, or checking\nthe database locally"),(0,a.kt)("li",{parentName:"ul"},"It should then ",(0,a.kt)("a",{parentName:"li",href:"#sending-a-push-notification"},"send")," a push notification according\nto the rules described"),(0,a.kt)("li",{parentName:"ul"},"The server should then send a request to the gorush server including all the required\ninformation")),(0,a.kt)("h3",{id:"receiving-a-push-notification"},"Receiving a push notification"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"On receiving the notification, a client can open the right account by checking the\n",(0,a.kt)("inlineCode",{parentName:"li"},"installation_id")," included. The ",(0,a.kt)("inlineCode",{parentName:"li"},"chat_id")," MAY be used to open the chat if present."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"message")," can be decrypted and presented to the user. Otherwise messages can be pulled from the mailserver if the ",(0,a.kt)("inlineCode",{parentName:"li"},"message_id")," is no already present.")),(0,a.kt)("h2",{id:"protobuf-description"},"Protobuf description"),(0,a.kt)("h3",{id:"pushnotificationregistration"},"PushNotificationRegistration"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"token_type"),": the type of token. Currently supported is ",(0,a.kt)("inlineCode",{parentName:"p"},"APN_TOKEN")," for Apple Push\n",(0,a.kt)("inlineCode",{parentName:"p"},"device_token"),": the actual push notification token sent by ",(0,a.kt)("inlineCode",{parentName:"p"},"Firebase")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"APN"),"\nand ",(0,a.kt)("inlineCode",{parentName:"p"},"FIREBASE_TOKEN")," for firebase.\n",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id"),": the ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/account"},(0,a.kt)("inlineCode",{parentName:"a"},"installation_id"))," of the device\n",(0,a.kt)("inlineCode",{parentName:"p"},"access_token"),": the access token that will be given to clients to send push notifications\n",(0,a.kt)("inlineCode",{parentName:"p"},"enabled"),": whether the device wants to be sent push notifications\n",(0,a.kt)("inlineCode",{parentName:"p"},"version"),": a monotonically increasing number identifying the current ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationRegistration"),". Any time anything is changed in the record it MUST be increased by the client, otherwise the request will not be accepted.\n",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list"),": a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token")," encrypted with the AES key generated\nby Diffie\u2013Hellman between the publisher and the allowed\ncontact.\n",(0,a.kt)("inlineCode",{parentName:"p"},"blocked_chat_list"),": a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"SHA2-256")," hashes of chat ids.\nAny chat id in this list will not trigger a notification.\n",(0,a.kt)("inlineCode",{parentName:"p"},"unregister"),": whether the account should be unregistered\n",(0,a.kt)("inlineCode",{parentName:"p"},"grant"),": the grant for this specific server\n",(0,a.kt)("inlineCode",{parentName:"p"},"allow_from_contacts_only"),": whether the client only wants push notifications from contacts\n",(0,a.kt)("inlineCode",{parentName:"p"},"apn_topic"),": the APN topic for the push notification\n",(0,a.kt)("inlineCode",{parentName:"p"},"block_mentions"),": whether the client does not want to be notified on mentions\n",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_mentions_chat_list"),":  a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"SHA2-256")," hashes of chat ids where we want to receive mentions"),(0,a.kt)("h4",{id:"data-disclosed"},"Data disclosed"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Type of device owned by a given user"),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"FIREBASE")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"APN")," push notification token"),(0,a.kt)("li",{parentName:"ul"},"Hash of the chat_id a user is not interested in for notifications"),(0,a.kt)("li",{parentName:"ul"},"The times a push notification record has been modified by the user"),(0,a.kt)("li",{parentName:"ul"},"The number of contacts a client has, in case ",(0,a.kt)("inlineCode",{parentName:"li"},"allowed_key_list")," is set")),(0,a.kt)("h3",{id:"pushnotificationregistrationresponse"},"PushNotificationRegistrationResponse"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"success"),": whether the registration was successful\n",(0,a.kt)("inlineCode",{parentName:"p"},"error"),": the error type, if any\n",(0,a.kt)("inlineCode",{parentName:"p"},"request_id"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," hash of the ",(0,a.kt)("inlineCode",{parentName:"p"},"signature")," of the request\n",(0,a.kt)("inlineCode",{parentName:"p"},"preferences"),": the server stored preferences in case of an error"),(0,a.kt)("h3",{id:"contactcodeadvertisement"},"ContactCodeAdvertisement"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"push_notification_info"),": the information for each device advertised"),(0,a.kt)("p",null,"Data disclosed"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The chat key of the sender")),(0,a.kt)("h3",{id:"pushnotificationquery"},"PushNotificationQuery"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"public_keys"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the public keys the client is interested in"),(0,a.kt)("p",null,"Data disclosed"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The hash of the public keys the client is interested in")),(0,a.kt)("h3",{id:"pushnotificationqueryinfo"},"PushNotificationQueryInfo"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"access_token"),": the access token used to send a push notification\n",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id")," of the device associated with the ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token"),"\n",(0,a.kt)("inlineCode",{parentName:"p"},"public_key"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the public key associated with this ",(0,a.kt)("inlineCode",{parentName:"p"},"access_token")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id"),"\n",(0,a.kt)("inlineCode",{parentName:"p"},"allowed_key_list"),": a list of encrypted access tokens to be returned\nto the client in case there's any filtering on public keys in place.\n",(0,a.kt)("inlineCode",{parentName:"p"},"grant"),": the grant used to register with this server.\n",(0,a.kt)("inlineCode",{parentName:"p"},"version"),": the version of the registration on the server.\n",(0,a.kt)("inlineCode",{parentName:"p"},"server_public_key"),": the compressed public key of the server."),(0,a.kt)("h3",{id:"pushnotificationqueryresponse"},"PushNotificationQueryResponse"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"info"),":  a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationQueryInfo"),".\n",(0,a.kt)("inlineCode",{parentName:"p"},"message_id"),": the message id of the ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationQueryInfo")," the server is replying to.\n",(0,a.kt)("inlineCode",{parentName:"p"},"success"),": whether the query was successful."),(0,a.kt)("h3",{id:"pushnotification"},"PushNotification"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"access_token"),": the access token used to send a push notification.\n",(0,a.kt)("inlineCode",{parentName:"p"},"chat_id"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the ",(0,a.kt)("inlineCode",{parentName:"p"},"chat_id"),".\n",(0,a.kt)("inlineCode",{parentName:"p"},"public_key"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the compressed public key of the receiving client.\n",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id"),": the installation id of the receiving client.\n",(0,a.kt)("inlineCode",{parentName:"p"},"message"),": the encrypted message that is being notified on.\n",(0,a.kt)("inlineCode",{parentName:"p"},"type"),": the type of the push notification, either ",(0,a.kt)("inlineCode",{parentName:"p"},"MESSAGE")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"MENTION"),"\n",(0,a.kt)("inlineCode",{parentName:"p"},"author"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"SHAKE-256")," of the public key of the sender"),(0,a.kt)("p",null,"Data disclosed"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"SHAKE-256")," of the ",(0,a.kt)("inlineCode",{parentName:"li"},"chat_id")," the notification is to be sent for"),(0,a.kt)("li",{parentName:"ul"},"The cypher text of the message"),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"SHAKE-256")," of the public key of the sender"),(0,a.kt)("li",{parentName:"ul"},"The type of notification")),(0,a.kt)("h3",{id:"pushnotificationrequest"},"PushNotificationRequest"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"requests"),": a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotification"),"\n",(0,a.kt)("inlineCode",{parentName:"p"},"message_id"),": the ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/payloads"},"status message id")),(0,a.kt)("p",null,"Data disclosed"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The status message id for which the notification is for")),(0,a.kt)("h3",{id:"pushnotificationresponse"},"PushNotificationResponse"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"message_id"),": the ",(0,a.kt)("inlineCode",{parentName:"p"},"message_id")," being notified on.\n",(0,a.kt)("inlineCode",{parentName:"p"},"reports"),": a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"PushNotificationReport")),(0,a.kt)("h3",{id:"pushnotificationreport"},"PushNotificationReport"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"success"),": whether the push notification was successful.\n",(0,a.kt)("inlineCode",{parentName:"p"},"error"),": the type of the error in case of failure.\n",(0,a.kt)("inlineCode",{parentName:"p"},"public_key"),": the public key of the user being notified.\n",(0,a.kt)("inlineCode",{parentName:"p"},"installation_id"),": the installation id of the user being notified."),(0,a.kt)("h2",{id:"anonymous-mode-of-operations"},"Anonymous mode of operations"),(0,a.kt)("p",null,"An anonymous mode of operations MAY be provided by the client, where the\nresponsibility of propagating information about the user is left to the client,\nin order to preserve privacy."),(0,a.kt)("p",null,"A client in anonymous mode can register with the server using a key different\nfrom their chat key.\nThis will hide their real chat key."),(0,a.kt)("p",null,"This public key is effectively a secret and SHOULD only be disclosed to clients that you the user wants to be notified by."),(0,a.kt)("p",null,"A client MAY advertise the access token on the contact-code topic of the key generated.\nA client MAY share their public key through ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/payloads##contact-update"},"contact updates")),(0,a.kt)("p",null,"A client receiving a push notification public key SHOULD listen to the contact code\ntopic of the push notification public key for updates."),(0,a.kt)("p",null,"The method described above effectively does not share the identity of the sender\nnor the receiver to the server, but MAY result in missing push notifications as\nthe propagation of the secret is left to the client."),(0,a.kt)("p",null,"This can be mitigated by ",(0,a.kt)("a",{parentName:"p",href:"/status/deprecated/payloads"},"device syncing"),", but not completely\naddressed."),(0,a.kt)("h2",{id:"security-considerations"},"Security considerations"),(0,a.kt)("p",null,"If no anonymous mode is used, when registering with a push notification service a client discloses:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The chat key"),(0,a.kt)("li",{parentName:"ul"},"The devices that will receive notifications")),(0,a.kt)("p",null,"A client MAY disclose:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The hash of the chat_ids they want to filter out")),(0,a.kt)("p",null,"When running in anonymous mode, the client's chat key is not disclosed."),(0,a.kt)("p",null,"When querying a push notification server a client will disclose:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"That it is interested in sending push notification to another client,\nbut the querying client's chat key is not disclosed")),(0,a.kt)("p",null,"When sending a push notification a client discloses:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"SHAKE-256")," of the chat id")),(0,a.kt)("p",null,"[//]",": This section can be removed, for now leaving it here in order to help with the\nreview process. Point can be integrated, suggestion welcome."),(0,a.kt)("h2",{id:"faq"},"FAQ"),(0,a.kt)("h3",{id:"why-having-acl-done-at-the-server-side-and-not-the-client"},"Why having ACL done at the server side and not the client?"),(0,a.kt)("p",null,"We looked into silent notification for\n",(0,a.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/pushing_background_updates_to_your_app"},"IOS")," (android has no equivalent)\nbut can't be used as it's expected to receive maximum 2/3 per hour, so not our use case. There\nare also issue when the user force quit the app."),(0,a.kt)("h3",{id:"why-using-an-access-token"},"Why using an access token?"),(0,a.kt)("p",null,"The access token is used to decouple the requesting information from the user from\nactually sending the push notification."),(0,a.kt)("p",null,"Some ACL is necessary otherwise it would be too easy to spam users (it's still fairly\ntrivial, but with this method you could allow only contacts to send you push notifications)."),(0,a.kt)("p",null,"Therefore your identity must be revealed to the server either when sending or querying."),(0,a.kt)("p",null,"By using an access token we increase deniability, as the server would know\nwho requested the token but not necessarily who sent a push notification.\nCorrelation between the two can be trivial in some cases."),(0,a.kt)("p",null,"This also allows a mode of use as we had before, where the server does not propagate\ninfo at all, and it's left to the user to propagate the token, through contact requests\nfor example."),(0,a.kt)("h3",{id:"why-advertise-with-the-bundle"},"Why advertise with the bundle?"),(0,a.kt)("p",null,"Advertising with the bundle allows us to piggy-back on an already implemented behavior\nand save some bandwidth in cases where is not filtering by public keys"),(0,a.kt)("h3",{id:"whats-the--bandwidth-impact-for-this"},"What's the  bandwidth impact for this?"),(0,a.kt)("p",null,"Generally speaking, for each 1-to-1 message and group chat message you will sending\n1 and ",(0,a.kt)("inlineCode",{parentName:"p"},"number of participants")," push notifications. This can be optimized if\nmultiple users are using the same push notification server. Queries have also\na bandwidth impact but they are made only when actually needed"),(0,a.kt)("h3",{id:"whats-the-information-disclosed"},"What's the information disclosed?"),(0,a.kt)("p",null,"The data disclosed with each message sent by the client is above, but for a summary:"),(0,a.kt)("p",null,"When you register with a push notification service you may disclose:"),(0,a.kt)("p",null,"1) Your chat key\n2) Which devices you have\n3) The hash of the chat_ids you want to filter out\n4) The hash of the public keys you are interested/not interested in"),(0,a.kt)("p",null,"When you query a notification service you may disclose:"),(0,a.kt)("p",null,"1) Your chat key\n2) The fact that you are interested in sending push notification to a given user"),(0,a.kt)("p",null,"Effectively this is fairly revealing if the user has a whitelist implemented.\nTherefore sending notification should be optional."),(0,a.kt)("h3",{id:"what-prevents-a-user-from-generating-a-random-key-and-getting-an-access-token-and-spamming"},"What prevents a user from generating a random key and getting an access token and spamming?"),(0,a.kt)("p",null,"Nothing really, that's the same as the status app as a whole. the only mechanism that prevents\nthis is using a white-list as described above,\nbut that implies disclosing your true identity to the push notification server."),(0,a.kt)("h3",{id:"why-not-0-knowledge-proofsquantum-computing"},"Why not 0-knowledge proofs/quantum computing"),(0,a.kt)("p",null,"We start simple, we can iterate"),(0,a.kt)("h3",{id:"how-to-handle-backwardforward-compatibility"},"How to handle backward/forward compatibility"),(0,a.kt)("p",null,"Most of the request have a target, so protocol negotiation can happen. We cannot negotiated\nthe advertisement as that's effectively a broadcast, but those info should not change and we can\nalways accrete the message."),(0,a.kt)("h3",{id:"why-ack_key"},"Why ack_key?"),(0,a.kt)("p",null,"That's necessary to avoid duplicated push notifications and allow for the retry\nin case the notification is not successful."),(0,a.kt)("p",null,"Deduplication of the push notification is done on the client side, to reduce a bit\nof centralization and also in order not to have to modify gorush."),(0,a.kt)("h3",{id:"can-i-run-my-own-node"},"Can I run my own node?"),(0,a.kt)("p",null,"Sure, the methods allow that"),(0,a.kt)("h3",{id:"can-i-register-with-multiple-nodes-for-redundancy"},"Can I register with multiple nodes for redundancy"),(0,a.kt)("p",null,"Yep"),(0,a.kt)("h3",{id:"what-does-my-node-disclose"},"What does my node disclose?"),(0,a.kt)("p",null,"Your node will disclose the IP address is running from, as it makes an HTTP post to\ngorush. A waku adapter could be used, but please not now."),(0,a.kt)("h3",{id:"does-this-have-high-reliability-requirements"},"Does this have high-reliability requirements?"),(0,a.kt)("p",null,"The gorush server yes, no way around it."),(0,a.kt)("p",null,"The rest, kind of, at least one node having your token needs to be up for you to receive notifications.\nBut you can register with multiple servers (desktop, status, etc) if that's a concern."),(0,a.kt)("h3",{id:"can-someone-else-ie-not-status-run-this"},"Can someone else (i.e not status) run this?"),(0,a.kt)("p",null,"Push notification servers can be run by anyone. Gorush can be run by anyone I take,\nbut we are in charge of the certificate, so they would not be able to notify status-clients."),(0,a.kt)("h2",{id:"changelog"},"Changelog"),(0,a.kt)("h3",{id:"version-01"},"Version 0.1"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/status-im/specs/commit/"},"Released")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Initial version")),(0,a.kt)("h2",{id:"copyright"},"Copyright"),(0,a.kt)("p",null,"Copyright and related rights waived via ",(0,a.kt)("a",{parentName:"p",href:"https://creativecommons.org/publicdomain/zero/1.0/"},"CC0"),"."),(0,a.kt)("h2",{id:"references"},"References"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html#//apple_ref/doc/uid/TP40008194-CH8-SW1"},"APN Service")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/uikit/app_and_environment/scenes/preparing_your_ui_to_run_in_the_background/updating_your_app_with_background_app_refresh"},"Background Execution on iOS")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://firebase.google.com/"},"Firebase")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/appleboy/gorush"},"Gorush")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/rfc4122"},"UUID Specification")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/status/deprecated/secure-transport"},"Secure Transport")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/pushing_background_updates_to_your_app"},"Silent Notifications on iOS")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/status/deprecated/waku-usage"},"Waku Usage")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/ensdomains/ens"},"ENS Contract")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/status/deprecated/payloads"},"Payloads"))))}u.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=i.createContext({}),p=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=p(e.components);return i.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),c=p(n),h=a,k=c["".concat(l,".").concat(h)]||c[h]||u[h]||o;return n?i.createElement(k,s(s({ref:t},d),{},{components:n})):i.createElement(k,s({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=c;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:a,s[1]=r;for(var p=2;p<o;p++)s[p]=n[p];return i.createElement.apply(null,s)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"}}]);