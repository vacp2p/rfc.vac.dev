"use strict";(self.webpackChunklogos_docs_template=self.webpackChunklogos_docs_template||[]).push([[1381],{80753:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var n=a(87462),i=(a(67294),a(3905));const r={title:"WAKU-USAGE",name:"Waku Usage",status:"deprecated",description:"Status uses Waku to provide privacy-preserving routing and messaging on top of devP2P.",editor:"Filip Dimitrijevic &lt;filip@status.im&gt;",contributors:["Adam Babik &lt;adam@status.im&gt;","Corey Petty &lt;corey@status.im&gt;","Oskar Thor\xe9n &lt;oskar@status.im&gt;","Samuel Hawksby-Robinson &lt;samuel@status.im&gt;"]},l=void 0,o={unversionedId:"deprecated/waku-usage",id:"deprecated/waku-usage",title:"WAKU-USAGE",description:"Status uses Waku to provide privacy-preserving routing and messaging on top of devP2P.",source:"@site/status/deprecated/waku-usage.md",sourceDirName:"deprecated",slug:"/deprecated/waku-usage",permalink:"/status/deprecated/waku-usage",draft:!1,tags:[],version:"current",frontMatter:{title:"WAKU-USAGE",name:"Waku Usage",status:"deprecated",description:"Status uses Waku to provide privacy-preserving routing and messaging on top of devP2P.",editor:"Filip Dimitrijevic &lt;filip@status.im&gt;",contributors:["Adam Babik &lt;adam@status.im&gt;","Corey Petty &lt;corey@status.im&gt;","Oskar Thor\xe9n &lt;oskar@status.im&gt;","Samuel Hawksby-Robinson &lt;samuel@status.im&gt;"]},sidebar:"defaultSidebar",previous:{title:"WAKU-MAILSERVER",permalink:"/status/deprecated/waku-mailserver"},next:{title:"WHISPER-MAILSERVER",permalink:"/status/deprecated/whisper-mailserver"}},s={},p=[{value:"Abstract",id:"abstract",level:2},{value:"Reason",id:"reason",level:2},{value:"Terminology",id:"terminology",level:2},{value:"Waku packets",id:"waku-packets",level:2},{value:"Waku node configuration",id:"waku-node-configuration",level:2},{value:"Status",id:"status",level:2},{value:"Rate limiting",id:"rate-limiting",level:2},{value:"Keys management",id:"keys-management",level:2},{value:"Contact code topic",id:"contact-code-topic",level:3},{value:"Partitioned topic",id:"partitioned-topic",level:3},{value:"Public chats",id:"public-chats",level:3},{value:"Group chat topic",id:"group-chat-topic",level:3},{value:"Negotiated topic",id:"negotiated-topic",level:3},{value:"Flow",id:"flow",level:3},{value:"Message encryption",id:"message-encryption",level:2},{value:"Message confirmations",id:"message-confirmations",level:2},{value:"Waku V1 extensions",id:"waku-v1-extensions",level:2},{value:"Request historic messages",id:"request-historic-messages",level:3},{value:"wakuext_requestMessages",id:"wakuext_requestmessages",level:4},{value:"Changelog",id:"changelog",level:2},{value:"Version 0.1",id:"version-01",level:3},{value:"Copyright",id:"copyright",level:2},{value:"References",id:"references",level:2}],d={toc:p};function m(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Status: deprecated"),(0,i.kt)("li",{parentName:"ul"},"Editor: Filip Dimitrijevic ","<",(0,i.kt)("a",{parentName:"li",href:"mailto:filip@status.im"},"filip@status.im"),">"),(0,i.kt)("li",{parentName:"ul"},"Contributors:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Adam Babik ","<",(0,i.kt)("a",{parentName:"li",href:"mailto:adam@status.im"},"adam@status.im"),">"),(0,i.kt)("li",{parentName:"ul"},"Corey Petty ","<",(0,i.kt)("a",{parentName:"li",href:"mailto:corey@status.im"},"corey@status.im"),">"),(0,i.kt)("li",{parentName:"ul"},"Oskar Thor\xe9n ","<",(0,i.kt)("a",{parentName:"li",href:"mailto:oskar@status.im"},"oskar@status.im"),">"),(0,i.kt)("li",{parentName:"ul"},"Samuel Hawksby-Robinson ","<",(0,i.kt)("a",{parentName:"li",href:"mailto:samuel@status.im"},"samuel@status.im"),">")))),(0,i.kt)("h2",{id:"abstract"},"Abstract"),(0,i.kt)("p",null,"Status uses ",(0,i.kt)("a",{parentName:"p",href:"/waku/standards/legacy/6/waku1"},"Waku")," to provide privacy-preserving routing\nand messaging on top of devP2P.\nWaku uses topics to partition its messages,\nand these are leveraged for all chat capabilities.\nIn the case of public chats, the channel name maps directly to its Waku topic.\nThis allows anyone to listen on a single channel."),(0,i.kt)("p",null,"Additionally, since anyone can receive Waku envelopes,\nit relies on the ability to decrypt messages to decide who is the correct recipient.\nStatus nodes do not rely upon this property,\nand implement another secure transport layer on top of Whisper."),(0,i.kt)("h2",{id:"reason"},"Reason"),(0,i.kt)("p",null,"Provide routing, metadata protection, topic-based multicasting and basic\nencryption properties to support asynchronous chat."),(0,i.kt)("h2",{id:"terminology"},"Terminology"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("em",{parentName:"li"},"Waku node"),": an Ethereum node with Waku V1 enabled"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("em",{parentName:"li"},"Waku network"),": a group of Waku nodes connected together through the internet connection and forming a graph"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("em",{parentName:"li"},"Message"),": a decrypted Waku message"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("em",{parentName:"li"},"Offline message"),": an archived envelope"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("em",{parentName:"li"},"Envelope"),": an encrypted message with metadata like topic and Time-To-Live")),(0,i.kt)("h2",{id:"waku-packets"},"Waku packets"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Packet Name"),(0,i.kt)("th",{parentName:"tr",align:"right"},"Code"),(0,i.kt)("th",{parentName:"tr",align:null},"References"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Status"),(0,i.kt)("td",{parentName:"tr",align:"right"},"0"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"status"},"Status"),", ",(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##status"},"WAKU-1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Messages"),(0,i.kt)("td",{parentName:"tr",align:"right"},"1"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##messages"},"WAKU-1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Batch Ack"),(0,i.kt)("td",{parentName:"tr",align:"right"},"11"),(0,i.kt)("td",{parentName:"tr",align:null},"Undocumented. Marked for Deprecation")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Message Response"),(0,i.kt)("td",{parentName:"tr",align:"right"},"12"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##batch-ack-and-message-response"},"WAKU-1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Status Update"),(0,i.kt)("td",{parentName:"tr",align:"right"},"22"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##status-update"},"WAKU-1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"P2P Request Complete"),(0,i.kt)("td",{parentName:"tr",align:"right"},"125"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/status/deprecated/waku-mailserver"},"4/WAKU-MAILSERVER"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"P2P Request"),(0,i.kt)("td",{parentName:"tr",align:"right"},"126"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/status/deprecated/waku-mailserver"},"4/WAKU-MAILSERVER"),", ",(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##p2p-request"},"WAKU-1"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"P2P Messages"),(0,i.kt)("td",{parentName:"tr",align:"right"},"127"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/status/deprecated/waku-mailserver"},"4/WAKU-MAILSERVER"),", ",(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##p2p-request-complete"},"WAKU-1"))))),(0,i.kt)("h2",{id:"waku-node-configuration"},"Waku node configuration"),(0,i.kt)("p",null,"A Waku node must be properly configured to receive messages from Status clients."),(0,i.kt)("p",null,"Nodes use Waku's Proof Of Work algorithm to deter denial of service and various spam/flood attacks against the Whisper network.\nThe sender of a message must perform some work which in this case means processing time.\nBecause Status' main client is a mobile client, this easily leads to battery draining and poor performance of the app itself.\nHence, all clients MUST use the following Whisper node settings:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"proof-of-work requirement not larger than ",(0,i.kt)("inlineCode",{parentName:"li"},"0.002")," for payloads less than 50,000 bytes"),(0,i.kt)("li",{parentName:"ul"},"proof-of-work requirement not larger than ",(0,i.kt)("inlineCode",{parentName:"li"},"0.000002")," for payloads greater than or equal to 50,000 bytes"),(0,i.kt)("li",{parentName:"ul"},"time-to-live not lower than ",(0,i.kt)("inlineCode",{parentName:"li"},"10")," (in seconds)")),(0,i.kt)("h2",{id:"status"},"Status"),(0,i.kt)("p",null,"Handshake is a RLP-encoded packet sent to a newly connected peer. It MUST start with a Status Code (",(0,i.kt)("inlineCode",{parentName:"p"},"0x00"),") and follow up with items:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"[\n  [ pow-requirement-key pow-requirement ]\n  [ bloom-filter-key bloom-filter ]\n  [ light-node-key light-node ]\n  [ confirmations-enabled-key confirmations-enabled ]\n  [ rate-limits-key rate-limits ]\n  [ topic-interest-key topic-interest ]\n]\n")),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Option Name"),(0,i.kt)("th",{parentName:"tr",align:null},"Key"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"),(0,i.kt)("th",{parentName:"tr",align:null},"References"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"pow-requirement")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"0x00")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint64")),(0,i.kt)("td",{parentName:"tr",align:null},"minimum PoW accepted by the peer"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##pow-requirement-field"},"WAKU-1#pow-requirement"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bloom-filter")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"0x01")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"[]byte")),(0,i.kt)("td",{parentName:"tr",align:null},"bloom filter of Waku topic accepted by the peer"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##bloom-filter-field"},"WAKU-1#bloom-filter"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"light-node")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"0x02")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bool")),(0,i.kt)("td",{parentName:"tr",align:null},"when true, the peer won't forward envelopes through the Messages packet."),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##light-node"},"WAKU-1#light-node"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"confirmations-enabled")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"0x03")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bool")),(0,i.kt)("td",{parentName:"tr",align:null},"when true, the peer will send message confirmations"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##confirmations-enabled-field"},"WAKU-1#confirmations-enabled-field"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"rate-limits")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"0x04")),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"See ",(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##rate-limits-field"},"Rate limiting")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##rate-limits-field"},"WAKU-1#rate-limits"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"topic-interest")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"0x05")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"[10000][4]byte")),(0,i.kt)("td",{parentName:"tr",align:null},"Topic interest is used to share a node's interest in envelopes with specific topics. It does this in a more bandwidth considerate way, at the expense of some metadata protection. Peers MUST only send envelopes with specified topics."),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"/waku/standards/legacy/6/waku1##topic-interest-field"},"WAKU-1#topic-interest"),", ",(0,i.kt)("a",{parentName:"td",href:"https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability"},"the theoretical scaling model"))))),(0,i.kt)("h2",{id:"rate-limiting"},"Rate limiting"),(0,i.kt)("p",null,"In order to provide an optional very basic Denial-of-Service attack protection, each node SHOULD define its own rate limits.\nThe rate limits SHOULD be applied on IPs, peer IDs, and envelope topics."),(0,i.kt)("p",null,"Each node MAY decide to whitelist, i.e. do not rate limit, selected IPs or peer IDs."),(0,i.kt)("p",null,"If a peer exceeds node's rate limits, the connection between them MAY be dropped."),(0,i.kt)("p",null,"Each node SHOULD broadcast its rate limits to its peers using ",(0,i.kt)("inlineCode",{parentName:"p"},"rate limits")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"status-options")," via packet code ",(0,i.kt)("inlineCode",{parentName:"p"},"0x00")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"0x22"),". The rate limits is RLP-encoded information:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"[ IP limits, PeerID limits, Topic limits ]\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"IP limits"),": 4-byte wide unsigned integer\n",(0,i.kt)("inlineCode",{parentName:"p"},"PeerID limits"),": 4-byte wide unsigned integer\n",(0,i.kt)("inlineCode",{parentName:"p"},"Topic limits"),": 4-byte wide unsigned integer"),(0,i.kt)("p",null,"The rate limits MAY also be sent as an optional parameter in the handshake."),(0,i.kt)("p",null,"Each node SHOULD respect rate limits advertised by its peers. The number of packets SHOULD be throttled in order not to exceed peer's rate limits.\nIf the limit gets exceeded, the connection MAY be dropped by the peer."),(0,i.kt)("h2",{id:"keys-management"},"Keys management"),(0,i.kt)("p",null,"The protocol requires a key (symmetric or asymmetric) for the following actions:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"signing & verifying messages (asymmetric key)"),(0,i.kt)("li",{parentName:"ul"},"encrypting & decrypting messages (asymmetric or symmetric key).")),(0,i.kt)("p",null,"As nodes require asymmetric keys and symmetric keys to process incoming messages,\nthey must be available all the time and are stored in memory."),(0,i.kt)("p",null,"Keys management for PFS is described in ",(0,i.kt)("a",{parentName:"p",href:"/status/deprecated/secure-transport"},"5/SECURE-TRANSPORT"),"."),(0,i.kt)("p",null,"The Status protocols uses a few particular Waku topics to achieve its goals."),(0,i.kt)("h3",{id:"contact-code-topic"},"Contact code topic"),(0,i.kt)("p",null,"Nodes use the contact code topic to facilitate the discovery of X3DH bundles so that the first message can be PFS-encrypted."),(0,i.kt)("p",null,"Each user publishes periodically to this topic. If user A wants to contact user B, she SHOULD look for their bundle on this contact code topic."),(0,i.kt)("p",null,"Contact code topic MUST be created following the algorithm below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'contactCode := "0x" + hexEncode(activePublicKey) + "-contact-code"\n\nvar hash []byte = keccak256(contactCode)\nvar topicLen int = 4\n\nif len(hash) < topicLen {\n    topicLen = len(hash)\n}\n\nvar topic [4]byte\nfor i = 0; i < topicLen; i++ {\n    topic[i] = hash[i]\n}\n')),(0,i.kt)("h3",{id:"partitioned-topic"},"Partitioned topic"),(0,i.kt)("p",null,"Waku is broadcast-based protocol. In theory, everyone could communicate using a single topic but that would be extremely inefficient.\nOpposite would be using a unique topic for each conversation, however,\nthis brings privacy concerns because it would be much easier to detect whether and when two parties have an active conversation."),(0,i.kt)("p",null,"Nodes use partitioned topics to broadcast private messages efficiently.\nBy selecting a number of topic, it is possible to balance efficiency and privacy."),(0,i.kt)("p",null,"Currently, nodes set the number of partitioned topics to ",(0,i.kt)("inlineCode",{parentName:"p"},"5000"),". They MUST be generated following the algorithm below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},'var partitionsNum *big.Int = big.NewInt(5000)\nvar partition *big.Int = big.NewInt(0).Mod(publicKey.X, partitionsNum)\n\npartitionTopic := "contact-discovery-" + strconv.FormatInt(partition.Int64(), 10)\n\nvar hash []byte = keccak256(partitionTopic)\nvar topicLen int = 4\n\nif len(hash) < topicLen {\n    topicLen = len(hash)\n}\n\nvar topic [4]byte\nfor i = 0; i < topicLen; i++ {\n    topic[i] = hash[i]\n}\n')),(0,i.kt)("h3",{id:"public-chats"},"Public chats"),(0,i.kt)("p",null,"A public chat MUST use a topic derived from a public chat name following the algorithm below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"var hash []byte\nhash = keccak256(name)\n\ntopicLen = 4\nif len(hash) < topicLen {\n    topicLen = len(hash)\n}\n\nvar topic [4]byte\nfor i = 0; i < topicLen; i++ {\n    topic[i] = hash[i]\n}\n")),(0,i.kt)("h3",{id:"group-chat-topic"},"Group chat topic"),(0,i.kt)("p",null,"Group chats does not have a dedicated topic.\nAll group chat messages (including membership updates) are sent as one-to-one messages to multiple recipients."),(0,i.kt)("h3",{id:"negotiated-topic"},"Negotiated topic"),(0,i.kt)("p",null,"When a client sends a one to one message to another client, it MUST listen to their negotiated topic.\nThis is computed by generating a diffie-hellman key exchange between two members\nand taking the first four bytes of the ",(0,i.kt)("inlineCode",{parentName:"p"},"SHA3-256")," of the key generated."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"\nsharedKey, err := ecies.ImportECDSA(myPrivateKey).GenerateShared(\n      ecies.ImportECDSAPublic(theirPublicKey),\n      16,\n      16,\n)\n\n\nhexEncodedKey := hex.EncodeToString(sharedKey)\n\nvar hash []byte = keccak256(hexEncodedKey)\nvar topicLen int = 4\n\nif len(hash) < topicLen {\n    topicLen = len(hash)\n}\n\nvar topic [4]byte\nfor i = 0; i < topicLen; i++ {\n    topic[i] = hash[i]\n}\n")),(0,i.kt)("p",null,"A client SHOULD send to the negotiated topic only if it has received a message from all the devices included in the conversation."),(0,i.kt)("h3",{id:"flow"},"Flow"),(0,i.kt)("p",null,"To exchange messages with client ",(0,i.kt)("inlineCode",{parentName:"p"},"B"),", a client ",(0,i.kt)("inlineCode",{parentName:"p"},"A")," SHOULD:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Listen to client's ",(0,i.kt)("inlineCode",{parentName:"li"},"B")," Contact Code Topic to retrieve their bundle information, including a list of active devices"),(0,i.kt)("li",{parentName:"ul"},"Send a message on client's ",(0,i.kt)("inlineCode",{parentName:"li"},"B")," partitioned topic"),(0,i.kt)("li",{parentName:"ul"},"Listen to the Negotiated Topic between ",(0,i.kt)("inlineCode",{parentName:"li"},"A")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"B")),(0,i.kt)("li",{parentName:"ul"},"Once client ",(0,i.kt)("inlineCode",{parentName:"li"},"A")," receives a message from ",(0,i.kt)("inlineCode",{parentName:"li"},"B"),", the Negotiated Topic SHOULD be used")),(0,i.kt)("h2",{id:"message-encryption"},"Message encryption"),(0,i.kt)("p",null,"Even though, the protocol specifies an encryption layer that encrypts messages before passing them to the transport layer,\nWaku protocol requires each Waku message to be encrypted anyway."),(0,i.kt)("p",null,"The node encrypts public and group messages using symmetric encryption, and creates the key from a channel name string.\nThe implementation is available in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"},(0,i.kt)("inlineCode",{parentName:"a"},"shh_generateSymKeyFromPassword"))," JSON-RPC method of go-ethereum Whisper implementation."),(0,i.kt)("p",null,"The node encrypts one-to-one messages using asymmetric encryption."),(0,i.kt)("h2",{id:"message-confirmations"},"Message confirmations"),(0,i.kt)("p",null,"Sending a message is a complex process where many things can go wrong.\nMessage confirmations tell a node that a message originating from it has been seen by its direct peers."),(0,i.kt)("p",null,"A node MAY send a message confirmation for any batch of messages received in a packet Messages Code (",(0,i.kt)("inlineCode",{parentName:"p"},"0x01"),")."),(0,i.kt)("p",null,"A node sends a message confirmation using Batch Acknowledge packet (",(0,i.kt)("inlineCode",{parentName:"p"},"0x0b"),") or Message Response packet (",(0,i.kt)("inlineCode",{parentName:"p"},"0x0c"),")."),(0,i.kt)("p",null,"The Batch Acknowledge packet is followed by a keccak256 hash of the envelopes batch data (raw bytes)."),(0,i.kt)("p",null,"The Message Response packet is more complex and is followed by a Versioned Message Response:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-golang"},"[ Version, Response]\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Version"),": a version of the Message Response, equal to ",(0,i.kt)("inlineCode",{parentName:"p"},"1"),",\n",(0,i.kt)("inlineCode",{parentName:"p"},"Response"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"[ Hash, Errors ]")," where ",(0,i.kt)("inlineCode",{parentName:"p"},"Hash")," is a keccak256 hash of the envelopes batch data (raw bytes)\nfor which the confirmation is sent and ",(0,i.kt)("inlineCode",{parentName:"p"},"Errors")," is a list of envelope errors when processing the batch.\nA single error contains ",(0,i.kt)("inlineCode",{parentName:"p"},"[ Hash, Code, Description ]")," where ",(0,i.kt)("inlineCode",{parentName:"p"},"Hash")," is a hash of the processed envelope,\n",(0,i.kt)("inlineCode",{parentName:"p"},"Code")," is an error code and ",(0,i.kt)("inlineCode",{parentName:"p"},"Description")," is a descriptive error message."),(0,i.kt)("p",null,"The supported codes:\n",(0,i.kt)("inlineCode",{parentName:"p"},"1"),": means time sync error which happens when an envelope is too old\nor created in the future (the root cause is no time sync between nodes)."),(0,i.kt)("p",null,"The drawback of sending message confirmations is that it increases the noise in the network because for each sent message,\none or more peers broadcast a corresponding confirmation. To limit that, both Batch Acknowledge packet (",(0,i.kt)("inlineCode",{parentName:"p"},"0x0b"),")\nand Message Response packet (",(0,i.kt)("inlineCode",{parentName:"p"},"0x0c"),") are not broadcast to peers of the peers, i.e. they do not follow epidemic spread."),(0,i.kt)("p",null,"In the current Status network setup, only ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailservers")," support message confirmations.\nA client posting a message to the network and after receiving a confirmation can be sure that the message got processed by the ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver"),".\nIf additionally, sending a message is limited to non-",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver")," peers,\nit also guarantees that the message got broadcast through the network and it reached the selected ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver"),"."),(0,i.kt)("h2",{id:"waku-v1-extensions"},"Waku V1 extensions"),(0,i.kt)("h3",{id:"request-historic-messages"},"Request historic messages"),(0,i.kt)("p",null,"Sends a request for historic messages to a ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver"),".\nThe ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver")," node MUST be a direct peer and MUST be marked as trusted (using ",(0,i.kt)("inlineCode",{parentName:"p"},"waku_markTrustedPeer"),")."),(0,i.kt)("p",null,"The request does not wait for the response.\nIt merely sends a peer-to-peer message to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver")," and it's up to ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver")," to process it and start sending historic messages."),(0,i.kt)("p",null,"The drawback of this approach is that it is impossible to tell which historic messages are the result of which request."),(0,i.kt)("p",null,"It's recommended to return messages from newest to oldest.\nTo move further back in time, use ",(0,i.kt)("inlineCode",{parentName:"p"},"cursor")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"limit"),"."),(0,i.kt)("h4",{id:"wakuext_requestmessages"},"wakuext_requestMessages"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Parameters"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Object - The message request object:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"mailServerPeer")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"String"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"Mailserver"),"'s enode address."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"from")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"Number")," (optional): Lower bound of time range as unix timestamp, default is 24 hours back from now."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"to")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"Number")," (optional): Upper bound of time range as unix timestamp, default is now."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"limit")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"Number")," (optional): Limit the number of messages sent back, default is no limit."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"cursor")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"String")," (optional): Used for paginated requests."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"topics")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"Array"),": hex-encoded message topics."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"symKeyID")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"String"),": an ID of a symmetric key used to authenticate with the ",(0,i.kt)("inlineCode",{parentName:"li"},"Mailserver"),", derived from the ",(0,i.kt)("inlineCode",{parentName:"li"},"Mailserver")," password.")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Returns"),":\n",(0,i.kt)("inlineCode",{parentName:"p"},"Boolean")," - returns ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," if the request was sent."),(0,i.kt)("p",null,"The above ",(0,i.kt)("inlineCode",{parentName:"p"},"topics")," is then converted into a bloom filter and then and sent to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailserver"),"."),(0,i.kt)("h2",{id:"changelog"},"Changelog"),(0,i.kt)("h3",{id:"version-01"},"Version 0.1"),(0,i.kt)("p",null,"Released ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8"},"May 22, 2020")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Created document"),(0,i.kt)("li",{parentName:"ul"},"Forked from ",(0,i.kt)("a",{parentName:"li",href:"3-whisper-usage"},"3-whisper-usage")),(0,i.kt)("li",{parentName:"ul"},"Change to keep ",(0,i.kt)("inlineCode",{parentName:"li"},"Mailserver")," term consistent"),(0,i.kt)("li",{parentName:"ul"},"Replaced Whisper references with Waku"),(0,i.kt)("li",{parentName:"ul"},"Added ",(0,i.kt)("a",{parentName:"li",href:"#status"},"Status options")," section"),(0,i.kt)("li",{parentName:"ul"},"Updated ",(0,i.kt)("a",{parentName:"li",href:"#waku-packets"},"Waku packets")," section to match Waku"),(0,i.kt)("li",{parentName:"ul"},"Added that ",(0,i.kt)("inlineCode",{parentName:"li"},"Batch Ack")," is marked for deprecation"),(0,i.kt)("li",{parentName:"ul"},"Changed ",(0,i.kt)("inlineCode",{parentName:"li"},"shh_generateSymKeyFromPassword")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"waku_generateSymKeyFromPassword"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L172-L175"},"Exists here")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/eth-node/bridge/geth/public_waku_api.go#L33-L36"},"Exists here")))),(0,i.kt)("li",{parentName:"ul"},"Changed ",(0,i.kt)("inlineCode",{parentName:"li"},"shh_markTrustedPeer")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"waku_markTrustedPeer"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L100-L108"},"Exists here")))),(0,i.kt)("li",{parentName:"ul"},"Changed ",(0,i.kt)("inlineCode",{parentName:"li"},"shhext_requestMessages")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"wakuext_requestMessages"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/services/wakuext/api.go#L76-L139"},"Exists here"))))),(0,i.kt)("h2",{id:"copyright"},"Copyright"),(0,i.kt)("p",null,"Copyright and related rights waived via ",(0,i.kt)("a",{parentName:"p",href:"https://creativecommons.org/publicdomain/zero/1.0/"},"CC0"),"."),(0,i.kt)("h2",{id:"references"},"References"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"waku"},"Waku")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/waku/standards/legacy/6/waku1"},"WAKU1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/status/deprecated/waku-mailserver"},"WAKU-MAILSERVER")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/vacp2p/research/tree/dcc71f4779be832d3b5ece9c4e11f1f7ec24aac2/whisper_scalability"},"The theoretical scaling model")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/status/deprecated/secure-transport"},"SECURE-TRANSPORT")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/specs/commit/664dd1c9df6ad409e4c007fefc8c8945b8d324e8"},"May 22, 2020 commit")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/ethereum/go-ethereum/wiki/Whisper-v6-RPC-API#shh_generatesymkeyfrompassword"},(0,i.kt)("inlineCode",{parentName:"a"},"shh_generateSymKeyFromPassword"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L172-L175"},"Key Change #1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/eth-node/bridge/geth/public_waku_api.go#L33-L36"},"Key Change #2")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/waku/api.go#L100-L108"},"Key Change #3")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/status-im/status-go/blob/2d13ccf5ec3db7e48d7a96a7954be57edb96f12f/services/wakuext/api.go#L76-L139"},"Key Change #4"))))}m.isMDXComponent=!0},3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>u});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(a),u=i,k=c["".concat(s,".").concat(u)]||c[u]||m[u]||r;return a?n.createElement(k,l(l({ref:t},d),{},{components:a})):n.createElement(k,l({ref:t},d))}));function u(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,l=new Array(r);l[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"}}]);